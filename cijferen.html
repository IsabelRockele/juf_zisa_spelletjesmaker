<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Cijferen Werkblad Generator</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
  <style>
    body{font-family:sans-serif;background-color:#f0f2f5;margin:0;}
    .menu-knop{
      display:inline-block;background-color:#002d62;color:#fff;
      padding:12px 22px;text-decoration:none;border-radius:6px;font-weight:bold;margin:20px;
    }
    .main-container{display:flex;align-items:flex-start;gap:30px;padding:0 20px 20px;}
    .controls{
      flex:0 0 380px;padding:20px;border:1px solid #ccc;border-radius:8px;background:#fff;
      position:sticky;top:20px;
    }
    .controls-grid{display:grid;grid-template-columns:1fr;gap:15px;}
    .control-group{padding:10px;border:1px solid #e0e0e0;border-radius:5px;}
    .control-group h4{margin:0 0 10px;}
    .setting-item{margin-bottom:12px;display:flex;align-items:center;justify-content:space-between;}
    .setting-item:last-child{margin-bottom:0;}
    .controls label{font-size:16px;margin:0;}
    .oefentype-lijst div{display:block;margin-bottom:5px;}
    .actie-knoppen{margin-top:20px;display:flex;gap:10px;}
    .actie-knoppen button{flex-grow:1;padding:12px;font-size:16px;border:none;border-radius:5px;cursor:pointer;color:#fff;}
    #genereer-knop{background-color:#007bff;}
    #download-pdf{background-color:#28a745;}

    #print-area{display:block;width:210mm;margin:0 auto;padding:0;}
    .pagina{
      width:210mm;
      height:296.5mm;
      position:relative;
      background:#fff;
      border:1px solid #ddd;
      box-shadow:0 0 10px rgba(0,0,0,.1);
      margin:0 auto;
      break-inside:avoid-page; page-break-inside:avoid;
    }
    .page-inner{
      position: absolute;
      inset: 5mm 15mm 10mm 22mm;
      box-sizing: border-box;
      display: flex;
      flex-direction: column;
      gap: 22px;
    }
    .page-split{ page-break-before: always; }
    .pdf-mode .pagina{ border:none !important; box-shadow:none !important; margin:0 auto !important; }

    .werkblad-header{
      margin: 0;
      display: flex;
      flex-direction: column;
      gap: 18px;
      padding-top: 4mm;
    }
    .werkblad-header .naam{ font-size:16px; line-height:1.25; }
    .werkblad-header .titel{
      font-size:24px;
      font-weight:bold;
      text-align:center;
      line-height:1.2;
    }
    .werkblad{display:block;break-inside:avoid-page;page-break-inside:avoid;}
    .rij{
      --gap-x:36px;
      --gap-y: 26px;
      display:flex; gap:var(--gap-y) var(--gap-x); margin-bottom:var(--gap-y);
      break-inside:avoid-page; page-break-inside:avoid;
    }
    .werkblad.cols-4 .rij .oefening{flex:0 0 calc((100% - 3 * var(--gap-x)) / 4);}
    .werkblad.cols-3 .rij .oefening{flex:0 0 calc((100% - 2 * var(--gap-x)) / 3);}

    .oefening{
      position:relative;
      padding:12px;
      padding-top:44px; /* Ruimte voor de absolute '.vraag' */
      border:1px solid #ccc;border-radius:8px;
      box-sizing:border-box;
      break-inside:avoid-page; page-break-inside:avoid;
    }
    .vraag{
      font-size:19px;font-weight:bold;text-align:center;
      position:absolute;top:12px;left:50%;transform:translateX(-50%);width:100%;
    }
    
    .schatting {
      font-size: 16px;
      margin-bottom: 20px; 
      padding-left: 5px;   
    }
    .schatting div:first-child {
      margin-bottom: 4px; 
    }
    
    .schema-container{
      display:flex;
      align-items:flex-start;
      position:relative;
      margin-left: 26px; 
    }
    
    .operator{font-size:24px;font-weight:bold;position:absolute;top:160px;left:-26px;}
    .schema{border-collapse:collapse;}
    .schema td{
      width:43px;height:43px;border:2px solid #999 !important;text-align:center;
      font-size:19px;font-weight:bold;position:relative;vertical-align:bottom;padding-bottom:3px;box-sizing:border-box;
    }
    .header{
      color:#fff;font-size:21px;border-width:2px !important;vertical-align:middle;padding-bottom:0;
      -webkit-print-color-adjust:exact;print-color-adjust:exact;
    }
    .start-pijl{
      content:'';position:absolute;top:-12px;left:50%;transform:translateX(-50%);
      width:0;height:0;border-left:10px solid transparent;border-right:10px solid transparent;border-top:11px solid #f1c40f;
    }
    .honderd{background-color:#2980b9;}
    .tien{background-color:#27ae60;}
    .een{background-color:#f1c40f;}
    .onthoud-cel{vertical-align:middle !important;}
    .onthoud-cel.honderd{background-color:#a9cce3;}
    .onthoud-cel.tien{background-color:#a3e4d7;}
    .onthoud-cel.een{background-color:#f9e79f;}
    .getal-cel{background-color:#fdfdfd;}
    .schema .oplossing-cel{background-color:#ffffff;border-top:4px solid #000 !important;}

    @media (max-width:1200px){
      .main-container{flex-direction:column;}
      .controls{position:static;width:100%;box-sizing:border-box;}
    }
  </style>
</head>
<body>

  <a href="index.html" class="menu-knop">Keuzemenu</a>

  <div class="main-container">
    <div class="controls">
      <h2>Instellingen</h2>
      <div class="controls-grid">
        <div class="control-group">
          <h4>Algemeen</h4>
          <div class="setting-item">
            <label for="type">Soort som:</label>
            <select id="type">
              <option value="plus">+</option>
              <option value="min">-</option>
              <option value="gemengd">Gemengd</option>
            </select>
          </div>

          <div class="setting-item">
            <label for="brug">Brug:</label>
            <select id="brug">
              <option value="beide">Beide</option>
              <option value="met">Met brug</option>
              <option value="zonder">Zonder brug</option>
            </select>
          </div>

          <div class="setting-item">
            <label for="invulling">Schema:</label>
            <select id="invulling">
              <option value="ingevuld">Ingevuld</option>
              <option value="leeg">Leeg</option>
            </select>
          </div>

          <div class="setting-item">
            <label for="schatting">Schatting:</label>
            <input type="checkbox" id="schatting" style="transform: scale(1.5);">
          </div>

          <div class="setting-item">
            <label for="startpijl">Startpijl:</label>
            <input type="checkbox" id="startpijl" checked style="transform: scale(1.5);">
          </div>

          <div class="setting-item">
            <label for="bereik">Bereik:</label>
            <select id="bereik">
              <option value="100" selected>tot 100</option>
              <option value="1000">tot 1000</option>
            </select>
          </div>

          <div class="setting-item">
            <label for="aantal">Aantal:</label>
            <input type="number" id="aantal" value="12" min="1" max="48" style="width:80px;">
          </div>
        </div>

        <div class="control-group">
          <h4>Kies Oefentypes (meerdere mogelijk)</h4>
          <div class="oefentype-lijst">
            <div><input type="checkbox" id="E_E"   name="oefentype" value="E_E">      <label for="E_E">E &pm; E</label></div>
            <div><input type="checkbox" id="TE_E"  name="oefentype" value="TE_E" checked> <label for="TE_E">TE &pm; E</label></div>
            <div><input type="checkbox" id="TE_T"  name="oefentype" value="TE_T">     <label for="TE_T">TE &pm; T</label></div>
            <div><input type="checkbox" id="TE_TE" name="oefentype" value="TE_TE">    <label for="TE_TE">TE &pm; TE</label></div>
            <div><input type="checkbox" id="HTE_E" name="oefentype" value="HTE_E">    <label for="HTE_E">HTE &pm; E</label></div>
            <div><input type="checkbox" id="HTE_T" name="oefentype" value="HTE_T">    <label for="HTE_T">HTE &pm; T</label></div>
            <div><input type="checkbox" id="HTE_TE" name="oefentype" value="HTE_TE">  <label for="HTE_TE">HTE &pm; TE</label></div>
            <div><input type="checkbox" id="HTE_HTE" name="oefentype" value="HTE_HTE"><label for="HTE_HTE">HTE &pm; HTE</label></div>
          </div>
        </div>
      </div>

      <div class="actie-knoppen">
        <button id="genereer-knop" onclick="genereerWerkblad()">Genereer Werkblad</button>
        <button id="download-pdf" onclick="downloadPDF()">Download als PDF</button>
      </div>
    </div>

    <div id="print-area"></div>
  </div>

  <script>
    function downloadPDF(){
      const element = document.getElementById('print-area');
      element.classList.add('pdf-mode');

      const opt = {
        margin:[0,0,0,0],
        filename:'cijferen_werkblad.pdf',
        image:{type:'jpeg',quality:0.98},
        html2canvas:{scale:2,useCORS:true},
        jsPDF:{unit:'mm',format:'a4',orientation:'portrait'},
        pagebreak:{mode:['css']}
      };

      html2pdf().from(element).set(opt).save().then(()=>{
        element.classList.remove('pdf-mode');
      });
    }

    function getRandomNumber(min, max){
      return Math.floor(Math.random()*(max-min+1))+min;
    }

    function createPagina(titelText='Extra oefenen op cijferen'){
      const pagina=document.createElement('div');
      pagina.className='pagina';
      const inner=document.createElement('div');
      inner.className='page-inner';
      const header=document.createElement('div');
      header.className='werkblad-header';
      header.innerHTML = `
        <div class="naam">Naam: _________________________</div>
        <div class="titel">${titelText}</div>
      `;
      const werkblad=document.createElement('div');
      werkblad.className='werkblad';
      inner.appendChild(header);
      inner.appendChild(werkblad);
      pagina.appendChild(inner);
      return {pagina, werkblad, inner};
    }

    function genereerWerkblad(){
      const type=document.getElementById('type').value;
      const brug=document.getElementById('brug').value;
      const invulling=document.getElementById('invulling').value;
      const bereik=parseInt(document.getElementById('bereik').value,10);
      const aantal=parseInt(document.getElementById('aantal').value,10);
      const metSchatting = document.getElementById('schatting').checked;
      const metStartpijl = document.getElementById('startpijl').checked; // Lees de nieuwe checkbox
      const printArea=document.getElementById('print-area');
      printArea.innerHTML='';

      const geselecteerdeTypes=Array.from(document.querySelectorAll('input[name="oefentype"]:checked')).map(cb=>cb.value);
      if(geselecteerdeTypes.length===0){ alert("Kies minstens één oefentype."); return; }
      
      const toegestaneTypes = (bereik===100)
        ? geselecteerdeTypes.filter(t=>!t.includes('H'))
        : geselecteerdeTypes.slice();

      if(toegestaneTypes.length===0){
        alert("In 'tot 100' zijn H-oefentypes niet toegestaan. Vink minstens één E/TE-type aan.");
        return;
      }

      let cols;
      if (bereik === 1000) {
        cols = 3;
      } else { 
        if (metSchatting) {
          cols = 3; 
        } else {
          cols = 4; 
        }
      }

      let {pagina, werkblad, inner}=createPagina();
      printArea.appendChild(pagina);
      werkblad.classList.add(cols===3?'cols-3':'cols-4');
      let rijDiv=null, inRij=0;
      
      let isEersteRij = true;

      const beginNieuwePagina = () => {
        const split=document.createElement('div');
        split.className='page-split';
        printArea.appendChild(split);
        ({pagina, werkblad, inner}=createPagina());
        printArea.appendChild(pagina);
        werkblad.classList.add(cols===3?'cols-3':'cols-4');
        rijDiv=null; inRij=0;
      };

      const pastRijOpPagina = () => inner.scrollHeight <= inner.clientHeight;

      for(let i=0;i<aantal;i++){
        const willekeurigType=toegestaneTypes[Math.floor(Math.random()*toegestaneTypes.length)];
        const currentType=(type==='gemengd')?(Math.random()<0.5?'plus':'min'):type;

        let getal1,getal2;
        let isMetBrug;
        if(brug==='met') isMetBrug=true;
        else if(brug==='zonder') isMetBrug=false;
        else isMetBrug=Math.random()<0.5;

        let attempts=0;
        while(attempts<200){
          const [type1,type2]=willekeurigType.split('_');
          const ranges={E:[1,9],T:[1,9],TE:[10,99],HTE:[100,999]};
          let g1=(type1==='T') ? getRandomNumber(ranges[type1][0],ranges[type1][1]) * 10 : getRandomNumber(ranges[type1][0],ranges[type1][1]);
          let g2=(type2==='T') ? getRandomNumber(ranges[type2][0],ranges[type2][1]) * 10 : getRandomNumber(ranges[type2][0],ranges[type2][1]);

          if(bereik===100){ g1=Math.min(g1,99); g2=Math.min(g2,99); }
          if(currentType==='plus'){ getal1=g1; getal2=g2; }
          else{
            getal1=Math.max(g1,g2); getal2=Math.min(g1,g2);
            if(getal1===getal2) getal1++;
          }

          const e1=getal1%10, e2=getal2%10;
          const t1=Math.floor(getal1/10)%10, t2=Math.floor(getal2/10)%10;

          let actueleBrug=false;
          if(currentType==='plus'){
            if(e1+e2>=10) actueleBrug=true;
            if((bereik===1000 || willekeurigType.includes('H')) && t1+t2>=10) actueleBrug=true;
          }else{
            if(e1<e2) actueleBrug=true;
            if((bereik===1000 || willekeurigType.includes('H')) && t1<t2) actueleBrug=true;
          }

          const result = (currentType==='plus') ? (getal1+getal2) : (getal1-getal2);
          if(bereik===100 && result>100){ attempts++; continue; }
          if(actueleBrug===isMetBrug || brug==='beide') break;
          attempts++;
        }

        if(!rijDiv || inRij===cols){
          rijDiv=document.createElement('div');
          rijDiv.className='rij';
          werkblad.appendChild(rijDiv);
          
          if(!isEersteRij && !pastRijOpPagina()){
            rijDiv.remove();
            beginNieuwePagina();
            rijDiv=document.createElement('div');
            rijDiv.className='rij';
            werkblad.appendChild(rijDiv);
          }
          inRij=0;
          isEersteRij = false;
        }

        const result = (currentType==='plus') ? (getal1+getal2) : (getal1-getal2);
        const showH = (bereik===1000) && (getal1>=100 || getal2>=100 || (currentType==='plus' && result>=100) || (currentType==='min'  && getal1>=100));
        
        // Geef de keuze voor de startpijl mee
        const kaartHTML = createOefeningHTML(getal1,getal2,currentType,showH,invulling,metSchatting, metStartpijl);
        
        const temp = document.createElement('div');
        temp.innerHTML = kaartHTML.trim();
        const kaart = temp.firstElementChild;
        rijDiv.appendChild(kaart);

        if(!isEersteRij && !pastRijOpPagina()){
          kaart.remove();
          if(rijDiv.children.length===0){
            rijDiv.remove();
          }
          beginNieuwePagina();
          rijDiv=document.createElement('div');
          rijDiv.className='rij';
          werkblad.appendChild(rijDiv);
          rijDiv.appendChild(kaart);
        }
        inRij++;
      }
    }

    // Functie accepteert nu 'metStartpijl'
    function createOefeningHTML(g1,g2,type,showH,invulling,metSchatting, metStartpijl){
      const op = type==='plus'?'+':'-';
      const vraag = `${g1} ${op} ${g2} = ?`;
      let H1='',T1='',E1='',H2='',T2='',E2='';

      if(invulling==='ingevuld'){
        const pad = showH?3:2;
        const g1_str = g1.toString().padStart(pad,' ');
        const g2_str = g2.toString().padStart(pad,' ');
        if(showH){ [H1,T1,E1]=g1_str.split(''); [H2,T2,E2]=g2_str.split(''); }
        else     { [T1,E1]=g1_str.split('');    [T2,E2]=g2_str.split('');    }
        [H1,T1,E1,H2,T2,E2]=[H1,T1,E1,H2,T2,E2].map(v=>v.trim());
      }
      
      let schattingHTML = '';
      if (metSchatting) {
        schattingHTML = `
          <div class="schatting">
            <div>Ik schat:</div>
            <div>__________________</div>
          </div>
        `;
      }
      
      // Maak de HTML voor de pijl alleen aan als de optie is aangevinkt
      let pijlHTML = '';
      if (metStartpijl) {
        pijlHTML = '<div class="start-pijl"></div>';
      }

      return `
        <div class="oefening">
          <div class="vraag">${vraag}</div>
          ${schattingHTML} 
          <div class="schema-container">
            <div class="operator">${op}</div>
            <table class="schema">
              <thead>
                <tr>
                  ${showH?'<td class="header honderd">H</td>':''}
                  <td class="header tien">T</td>
                  <td class="header een">E${pijlHTML}</td>
                </tr>
              </thead>
              <tbody>
                <tr>
                  ${showH?'<td class="onthoud-cel honderd"></td>':''}
                  <td class="onthoud-cel tien"></td>
                  <td class="onthoud-cel een"></td>
                </tr>
                <tr>
                  ${showH?`<td class="getal-cel">${H1}</td>`:''}
                  <td class="getal-cel">${T1}</td>
                  <td class="getal-cel">${E1}</td>
                </tr>
                <tr>
                  ${showH?`<td class="getal-cel">${H2}</td>`:''}
                  <td class="getal-cel">${T2}</td>
                  <td class="getal-cel">${E2}</td>
                </tr>
                <tr>
                  ${showH?'<td class="oplossing-cel"></td>':''}
                  <td class="oplossing-cel"></td>
                  <td class="oplossing-cel"></td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      `;
    }

    window.onload=genereerWerkblad;
  </script>

</body>
</html>