<!doctype html>
<html lang="nl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Zisa PRO – App</title>
  <meta name="color-scheme" content="light">
  <style>
    :root { --bg:#fff9e8; --card:#ffffff; --text:#1a1a1a; --muted:#6b7280; --brand:#f9b233; --danger:#ef4444; }
    * { box-sizing: border-box }
    body{margin:0;background:var(--bg);color:var(--text);font:16px/1.45 system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
    header{position:sticky;top:0;background:#fff;border-bottom:1px solid #eee;z-index:10}
    .bar{max-width:1100px;margin:0 auto;padding:10px 16px;display:flex;align-items:center;gap:12px}
    .grow{flex:1}
    .tag{font-size:12px;background:#f3f4f6;color:#111;padding:4px 8px;border-radius:999px}
    .btn{appearance:none;border:0;border-radius:10px;padding:10px 14px;background:var(--brand);color:#1f2937;font-weight:600;cursor:pointer}
    .btn.secondary{background:#e5e7eb}
    .btn.danger{background:var(--danger);color:#fff}
    .wrap{max-width:1100px;margin:24px auto;padding:0 16px}
    .card{background:var(--card);border-radius:14px;box-shadow:0 10px 30px rgba(0,0,0,.06);padding:18px;margin-bottom:16px}
    h1{margin:8px 0 4px}
    .muted{color:var(--muted)}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:14px}
    @media (max-width:900px){ .grid{grid-template-columns:1fr} }
    .log{background:#0b1020;color:#d8e1ff;border-radius:10px;padding:12px;white-space:pre-wrap;min-height:120px;font:13px ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;}
    [data-pro-only]{display:none}
  </style>
</head>
<body>
  <header>
    <div class="bar">
      <strong>Zisa PRO</strong>
      <span class="tag" id="proBadge">Status: onbekend</span>
      <div class="grow"></div>
      <span class="muted" id="who">Laden…</span>
      <button class="btn secondary" id="btnLogout" title="Uitloggen">Uitloggen</button>
    </div>
  </header>

  <main class="wrap">
    <div class="card">
      <h1>Welkom!</h1>
      <p class="muted" id="intro">
        Deze pagina is alleen zichtbaar na inloggen. Uw PRO-toegang wordt automatisch gecontroleerd.
      </p>
    </div>

    <div class="grid">
      <div class="card">
        <h3 style="margin:6px 0 10px">PRO-functies</h3>
        <p class="muted">Onderstaande demo roept een beveiligd endpoint aan. Server-side wordt uw sessiecode geverifieerd.</p>
        <div style="display:flex;gap:10px;flex-wrap:wrap">
          <button class="btn" id="btnProDemo" data-pro-only>Voer PRO-actie (demo)</button>
        </div>
      </div>

      <div class="card">
        <h3 style="margin:6px 0 10px">Log</h3>
        <div class="log" id="log"></div>
      </div>
    </div>
  </main>

  <!-- Firebase Web SDK (modular) -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-auth.js";
    import { getFunctions, httpsCallable } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-functions.js";

    // === Firebase-config van uw project ===
    const firebaseConfig = {
      apiKey: "AIzaSyA1svbzlhdjiiDMyRIgqQq1jSu_F8li3Bw",
      authDomain: "zisa-spelletjesmaker-pro.firebaseapp.com",
      projectId: "zisa-spelletjesmaker-pro",
      storageBucket: "zisa-spelletjesmaker-pro.firebasestorage.app",
      messagingSenderId: "828063957776",
      appId: "1:828063957776:web:8d8686b478846fe980db95",
      measurementId: "G-9LHNLFHSXX"
    };

    // === Init ===
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const functions = getFunctions(app, "europe-west1");

    // === Element helpers ===
    const $ = (id) => document.getElementById(id);
    const log = (msg) => { $("log").textContent += (typeof msg === "string" ? msg : JSON.stringify(msg, null, 2)) + "\n"; };

    // DeviceId dat stabiel blijft per browser
    function getDeviceId() {
      let id = localStorage.getItem("zisa_device_id");
      if (!id) { id = crypto.randomUUID(); localStorage.setItem("zisa_device_id", id); }
      return id;
    }

    function setProUI(enabled, expMillis) {
      // toon/verberg pro-only elementen
      document.querySelectorAll("[data-pro-only]").forEach(el => el.style.display = enabled ? "" : "none");
      const badge = $("proBadge");
      if (enabled) {
        const exp = expMillis ? new Date(expMillis).toISOString().slice(0,10) : "onbekend";
        badge.textContent = `PRO actief – geldig tot ${exp}`;
        badge.style.background = "#e9fbe7";
      } else {
        badge.textContent = "Geen PRO";
        badge.style.background = "#ffe8e8";
      }
    }

    // === Auth flow ===
    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        // Niet ingelogd → terug naar loginpagina
        location.replace("./index.html");
        return;
      }

      $("who").textContent = user.email;

      // Apparaat registreren en PRO-status ophalen
      try {
        const deviceId = getDeviceId();
        const registerDevice = httpsCallable(functions, "registerDevice");
        const resp = await registerDevice({ deviceId });
        log({ registerDevice: resp.data });

        if (resp.data?.ok) {
          setProUI(true, resp.data.expiresAt);
          $("intro").textContent = "U bent ingelogd en uw PRO-toegang is actief op dit apparaat.";
        } else {
          setProUI(false, null);
          const reason = resp.data?.reason || "onbekend";
          $("intro").textContent = `U bent ingelogd, maar PRO is niet actief (${reason}).`;
        }
      } catch (e) {
        console.error(e);
        log("registerDevice fout: " + e.message);
        setProUI(false, null);
        $("intro").textContent = "Kan uw PRO-status niet ophalen. Probeer later opnieuw.";
      }
    });

    // Uitloggen
    $("btnLogout").onclick = async () => {
      try { await signOut(auth); }
      finally { location.replace("./index.html"); }
    };

    // === Demo: PRO-actie (server-gevalideerd) ===
    $("btnProDemo").onclick = async () => {
      try {
        const user = auth.currentUser;
        if (!user) { log("Niet ingelogd."); return; }
        const deviceId = getDeviceId();

        // 1) sessiecode opvragen
        const issue = httpsCallable(functions, "issueSessionCode");
        const r1 = await issue({ deviceId });
        log({ issueSessionCode: r1.data });
        if (!r1.data?.ok) { log("Geen sessiecode: " + (r1.data?.reason || "onbekend")); return; }
        const code = r1.data.code;

        // 2) server-endpoint aanroepen (server valideert code)
        const r = await fetch("https://europe-west1-zisa-spelletjesmaker-pro.cloudfunctions.net/proDoSomething", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ userId: user.uid, deviceId, code, payload: { demo: "ok" } })
        });
        const j = await r.json();
        log({ proDoSomething: j });
      } catch (e) {
        log("PRO-actie fout: " + e.message);
      }
    };

    // (optioneel) service worker zoals voordien
    if ("serviceWorker" in navigator) {
      window.addEventListener("load", () => {
        navigator.serviceWorker.register("../sw.js").catch(console.error);
      });
    }
  </script>
</body>
</html>
