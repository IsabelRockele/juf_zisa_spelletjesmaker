<!doctype html>
<html lang="nl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Zisa PRO – Inloggen</title>
  <meta name="theme-color" content="#fffbe6" />
  <link rel="manifest" href="./manifest-pro.json" />
  <style>
    :root{
      --bg:#fffbe6;--card:#fff;--muted:#4b5563;--primary:#f9b600;--primary-pressed:#d89c00;
      --ring:rgba(249,182,0,.35);--border:#e5e7eb;--shadow:0 12px 28px rgba(0,0,0,.08);--radius:14px
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);font-family:system-ui,Segoe UI,Arial,sans-serif;color:#111}
    .wrap{min-height:100dvh;display:grid;place-items:center;padding:24px}
    .card{width:100%;max-width:640px;background:var(--card);border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow);padding:24px}
    h1{margin:.2rem 0 8px 0;font-size:28px;color:#f0a500}
    .muted{color:#6b7280}
    label{font-weight:600;display:block;margin:.75rem 0 .35rem}
    input[type=text]{width:100%;padding:.7rem .85rem;border:1px solid var(--border);border-radius:10px;outline:0;background:#fffbe6}
    input:focus{border-color:var(--primary);box-shadow:0 0 0 4px var(--ring)}
    .row{display:flex;gap:.6rem;align-items:center;margin-top:.6rem}
    .btn{border:1px solid var(--border);background:#f8fafc;color:#111;border-radius:10px;padding:.65rem 1rem;cursor:pointer}
    .btn.primary{background:var(--primary);border-color:var(--primary);color:#fff}
    .btn.primary:active{background:var(--primary-pressed)}
    .btn[disabled]{opacity:.65;cursor:not-allowed}
    details{margin-top:12px}
    pre{white-space:pre-wrap;background:#0b1220;color:#c7d2fe;padding:12px;border-radius:10px;max-height:320px;overflow:auto}
    #otpInfo{display:none;margin:.5rem 0 0 0}
    .inline-btn{display:inline-block;margin-left:8px;border:0;background:#ffd166;color:#3b2d00;padding:.2rem .5rem;border-radius:8px;cursor:pointer;font-size:.85rem}
  </style>
</head>
<body>
  <div class="wrap">
    <main class="card" role="main" aria-labelledby="title">
      <h1 id="title">Aanmelden</h1>
      <p class="muted">Log in met uw gebruikers-ID. U ontvangt een 6-cijferige code (OTP).</p>

      <section aria-label="Code aanvragen">
        <label for="uid">Gebruikers-ID</label>
        <input id="uid" type="text" autocomplete="username" placeholder="bv. jouw-UID of e-mail" />
        <div class="row">
          <button class="btn" id="btnReq" type="button">Code aanvragen</button>
        </div>
      </section>

      <section aria-label="OTP verifiëren" style="margin-top:.8rem">
        <div class="row">
          <div style="flex:1">
            <label for="code">6-cijferige code</label>
            <input id="code" type="text" inputmode="numeric" pattern="[0-9]{6}" autocomplete="one-time-code" placeholder="000000" />
          </div>
          <div>
            <button class="btn primary" id="btnVerify" type="button">Verifiëren &amp; inloggen</button>
          </div>
        </div>
        <p id="otpInfo" class="muted" aria-live="polite"></p>
      </section>

      <details>
        <summary>Geavanceerd / status</summary>
        <div class="row" style="flex-wrap:wrap">
          <button class="btn" id="btnMe" type="button">/auth/me</button>
          <button class="btn" id="btnPing" type="button">/ping</button>
          <button class="btn" id="btnClear" type="button">Log wissen</button>
        </div>
        <pre id="log" aria-live="polite"></pre>
      </details>
    </main>
  </div>

  <script>
    /* ===== Config ===== */
    const API_BASE = "https://api-xc54winygq-ew.a.run.app";
    const TOKEN_KEY = "zisa_token";

    // UX / regels
    const OTP_COOLDOWN_SEC = 60;     // wachttijd bij 429 (UI)
    const OTP_VALID_SEC    = 5 * 60; // 5 min
    const ADMIN_UID        = "isabel-admin";

    // Admin: inline code tonen (zoals u wenst)
    const ADMIN_INLINE_OTP = true;   // admin ziet code direct als backend 'displayCode' meegeeft

    // Elements / helpers
    const $ = id => document.getElementById(id);
    const $uid=$('uid'), $code=$('code'), $btnReq=$('btnReq'), $btnVerify=$('btnVerify');
    const $btnMe=$('btnMe'), $btnPing=$('btnPing'), $btnClear=$('btnClear');
    const $log=$('log'), $otpInfo=$('otpInfo');
    const log = (m) => { $log.textContent = (typeof m === 'string') ? m : JSON.stringify(m, null, 2); };

    const now = () => Math.floor(Date.now()/1000);
    const setInfo = html => { $otpInfo.innerHTML = html || ''; $otpInfo.style.display = html ? 'block' : 'none'; };

    // Cooldown (frontend)
    const setCooldown = (until)=> localStorage.setItem('otp_cooldown_until', String(until));
    const getCooldownLeft = ()=> Math.max(0, Number(localStorage.getItem('otp_cooldown_until')||0) - now());
    function syncCooldownUI(){
      const left = getCooldownLeft();
      if(left>0){
        $btnReq.disabled = true;
        $btnReq.textContent = `Code aanvragen (${left}s)`;
        const iv = setInterval(()=>{
          const l = getCooldownLeft();
          if (l<=0){
            clearInterval(iv);
            $btnReq.disabled = false;
            $btnReq.textContent = 'Code aanvragen';
            setInfo('U kunt opnieuw een code aanvragen. Tip: de vorige code kan nog geldig zijn.');
          } else {
            $btnReq.textContent = `Code aanvragen (${l}s)`;
          }
        }, 1000);
      } else {
        $btnReq.disabled = false;
        $btnReq.textContent = 'Code aanvragen';
      }
    }

    // Admin: vorige code 5 min beschikbaar (alleen lokaal in sessionStorage)
    const ADMIN_STORE_KEY = "admin_last_code"; // {code, ts}
    function saveAdminLastCode(code){
      try{ sessionStorage.setItem(ADMIN_STORE_KEY, JSON.stringify({code:String(code||''), ts:now()})); }catch(_){}
    }
    function getAdminLastCode(){
      try{
        const raw = sessionStorage.getItem(ADMIN_STORE_KEY);
        if (!raw) return null;
        const obj = JSON.parse(raw);
        if (!obj?.code || !obj?.ts) return null;
        if ((now()-obj.ts) > OTP_VALID_SEC) return null;
        return obj;
      }catch(_){ return null; }
    }
    function clearAdminLastCode(){ try{ sessionStorage.removeItem(ADMIN_STORE_KEY); }catch(_){} }

    function setValidityHint(){
      const t = Number(localStorage.getItem('otp_last_sent_ts')||0);
      const left = Math.max(0, OTP_VALID_SEC - (now() - t));
      const last = getAdminLastCode();

      if (last && left>0){
        const m = Math.floor(left/60), s = left%60;
        setInfo(`Hint: uw vorige code is mogelijk nog geldig (± ${m}m ${s}s).
                 <button type="button" id="fillPrev" class="inline-btn">Vorige code invullen</button>`);
        setTimeout(()=>{ const btn=document.getElementById('fillPrev'); if (btn) btn.onclick=()=>{ $code.value = last.code; $code.focus(); setInfo('Vorige code ingevuld. Klik op <em>Verifiëren</em>.'); }; },0);
      } else if (left>0){
        setInfo(`Hint: vorige code nog ong. ${Math.floor(left/60)}m ${left%60}s geldig.`);
      } else {
        setInfo('');
      }
    }

    // API helpers (oude paden die bij u werkten)
    const reqOtp = (uid) => fetch(`${API_BASE}/otp/request`, {
      method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ uid })
    });
    const verifyOtpCall = (uid, code) => fetch(`${API_BASE}/otp/verify`, {
      method:'POST', headers:{'Content-Type':'application/json'}, credentials:'include',
      body: JSON.stringify({ uid, code })
    });

    async function requestOtp(){
      const uid = $uid.value.trim();
      if (!uid){ alert('Vul uw gebruikers-ID in.'); return; }

      // géén frontend-blokkade voor admin; server bewaakt echte rate-limit
      if (uid !== ADMIN_UID){
        const left = getCooldownLeft();
        if (left>0){ setInfo(`Even geduld: u kunt over <strong>${left}s</strong> opnieuw een code aanvragen. Of gebruik uw vorige code zolang die nog geldig is.`); return; }
      }

      setInfo('Bezig met aanvragen…'); $btnReq.disabled = true;
      try{
        const r = await reqOtp(uid);
        const txt = await r.text(); let data={}; try{ data = JSON.parse(txt); }catch(_){}
        log({status:r.status, body:data||txt});

        if (r.status === 429){
          const ra = Number(r.headers.get('Retry-After')||OTP_COOLDOWN_SEC);
          setCooldown(now()+ra); syncCooldownUI();
          setInfo(`U heeft zojuist al een code aangevraagd. Wacht <strong>${ra}s</strong> of gebruik de vorige code (5 min).`);
          setValidityHint();
          return;
        }

        if (r.ok && data?.ok){
          localStorage.setItem('otp_last_sent_ts', String(now()));
          setCooldown(now()+OTP_COOLDOWN_SEC); syncCooldownUI();

          // ADMIN: code meteen invullen + bewaren (geen "Controleer uw e-mail"-tekst)
          if (uid===ADMIN_UID && ADMIN_INLINE_OTP && data.displayCode){
            $code.value = String(data.displayCode);
            saveAdminLastCode(data.displayCode);
            setValidityHint();
            setInfo('Admin-code is ingevuld. Klik op <strong>Verifiëren</strong>.');
            $code.focus();
          } else {
            // Niet-admin (of geen displayCode) → normale melding
            setValidityHint();
            setInfo('Code verzonden. <strong>Controleer uw e-mail</strong>.');
            $code.focus();
          }
          return;
        }

        if (data?.alreadyIssued || data?.error==='code-still-valid'){
          const ttl = Number(data?.ttl_left || 0);
          const m = Math.floor(ttl/60), s = ttl%60;
          setInfo(`Er is al een <strong>geldige code</strong> (nog ± ${m}m ${s}s). Gebruik die code opnieuw.`);
          setValidityHint();
          $btnReq.disabled = false;
          return;
        }

        setInfo(`Kon geen code aanvragen. <strong>Status ${r.status}</strong>. Probeer opnieuw.`);
        $btnReq.disabled = false;

      }catch(e){
        setInfo('Netwerkfout bij aanvragen. Controleer uw verbinding en probeer opnieuw.');
        log(String(e));
        $btnReq.disabled = false;
      }
    }

    async function verifyOtp(){
      const uid = $uid.value.trim();
      const code = $code.value.trim();
      if (!uid || !/^[0-9]{6}$/.test(code)){ alert('Vul een geldige ID en 6-cijferige code in.'); return; }

      setInfo('Bezig met verifiëren…'); $btnVerify.disabled = true;
      try{
        const r = await verifyOtpCall(uid, code);
        const txt = await r.text(); let data={}; try{ data = JSON.parse(txt); }catch(_){}
        log({status:r.status, body:data||txt});

        if (r.ok && data?.ok){
          if (data.token){ try{ localStorage.setItem(TOKEN_KEY, data.token); }catch(_){ } }
          // admin-quick path: wis bewaarde code bij succes
          clearAdminLastCode();
          location.href = './app.html';
          return;
        }

        // Code ongeldig/verlopen → duidelijke instructie + “vorige code” verwijderen
        if (data?.error === 'invalid-code' || r.status === 400 || r.status === 401){
          clearAdminLastCode();
          const left = getCooldownLeft();
          if (left>0){ setInfo(`Code onjuist of verlopen. Wacht <strong>${left}s</strong> en vraag daarna een nieuwe code aan.`); }
          else { setInfo('Code onjuist of verlopen. Vraag een nieuwe code aan.'); }
          $btnVerify.disabled = false;
          $code.select();
          return;
        }

        setInfo(`Verifiëren mislukt. <strong>Status ${r.status}</strong>. Probeer opnieuw.`);
        $btnVerify.disabled = false; $code.select();

      }catch(e){
        setInfo('Netwerkfout bij verifiëren. Controleer uw verbinding en probeer opnieuw.');
        log(String(e));
        $btnVerify.disabled = false;
      }
    }

    // Extra tools
    async function checkMe(){
      try{
        let resp = await fetch(`${API_BASE}/auth/me`, { credentials:'include' });
        const data = await resp.json().catch(()=>({}));
        log(data);
      }catch(e){ log({ok:false,error:String(e)}); }
    }
    function ping(){ fetch(`${API_BASE}/ping`).then(r=>r.json()).then(log).catch(e=>log(String(e))); }
    function clearLog(){ $log.textContent=''; }

    document.addEventListener('DOMContentLoaded', () => {
      // na uitloggen direct opnieuw kunnen → reset UI-cooldown
      localStorage.removeItem('otp_cooldown_until');

      // handlers
      $btnReq.onclick = requestOtp;
      $btnVerify.onclick = verifyOtp;
      $btnMe.onclick = checkMe;
      $btnPing.onclick = ping;
      $btnClear.onclick = clearLog;

      // UI init
      syncCooldownUI();
      setValidityHint();

      // Alleen lokaal (devgemak) mag het veld vooraf gevuld worden
      if ((location.hostname==='127.0.0.1'||location.hostname==='localhost') && !$uid.value) $uid.value = ADMIN_UID;

      // prettige focus
      const sent = Number(localStorage.getItem('otp_last_sent_ts')||0);
      (sent && (now()-sent)<OTP_VALID_SEC) ? $code.focus() : $uid.focus();
    });
  </script>
</body>
</html>














