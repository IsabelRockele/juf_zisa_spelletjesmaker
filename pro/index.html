<!doctype html>
<html lang="nl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Zisa PRO – inloggen</title>
  <style>
    :root { --accent:#f9b233; --bg:#fff7e8; --text:#1f2937; --muted:#6b7280; }
    html,body{margin:0;padding:0;background:var(--bg);color:var(--text);font:16px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial;}
    .wrap{max-width:880px;margin:48px auto;padding:0 16px;}
    .card{background:#fff;border-radius:14px;box-shadow:0 10px 30px rgba(0,0,0,.07);padding:24px;}
    h1{font-size:32px;margin:0 0 10px}
    p.small{color:var(--muted);margin:.5rem 0 0}
    .actions{margin-top:18px;display:flex;gap:12px;flex-wrap:wrap}
    button{appearance:none;border:0;border-radius:12px;padding:12px 16px;font-weight:600;cursor:pointer}
    .btn{background:var(--accent)}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    .btn-outline{background:#fff;border:2px solid #e5e7eb}
    .status{margin-top:16px;padding:14px;border-radius:12px;background:#fff7da;border:1px dashed #f1c86a;color:#3a3a20}
    .ok{background:#e8fbe8;border-color:#97e197}
    .err{background:#ffecec;border-color:#ffb3b3}
    .hide{display:none}
    .muted{color:var(--muted)}
    .spinner{width:16px;height:16px;border:3px solid #fff;border-bottom-color:transparent;border-radius:50%;display:inline-block;animation:spin .8s linear infinite;margin-left:8px;vertical-align:-2px}
    @keyframes spin{to{transform:rotate(360deg)}}
    footer{margin:28px 0;color:var(--muted);font-size:14px;text-align:center}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>Zisa PRO – inloggen</h1>
      <p class="small">Log in met <strong>hetzelfde e-mailadres als bij de aankoop</strong>. PRO-rechten worden automatisch geactiveerd.</p>

      <div class="actions" id="loginRow">
        <button id="btnGoogle" class="btn">Inloggen met Google</button>
        <button id="btnLogout" class="btn-outline hide">Uitloggen</button>
      </div>

      <div id="status" class="status hide"></div>
      <p id="currentUser" class="small muted" aria-live="polite"></p>
    </div>

    <footer>Heeft u vragen? Mail ons gerust: <a href="mailto:zebraklas@jufzisa.be">zebraklas@jufzisa.be</a></footer>
  </div>

  <script type="module">
    // ------------------ instellingen ------------------
    // Waarheen de klant na succesvol inloggen moet gaan:
    const APP_URL = "https://isabelrockele.github.io/juf_zisa_spelletjesmaker/"; // bv. jouw app-startpagina

    // Firebase config (jouw project)
    const firebaseConfig = {
      apiKey: "AIzaSyA1svbzlhdjiiDMyRIgqQq1jSu_F8li3Bw",
      authDomain: "zisa-spelletjesmaker-pro.firebaseapp.com",
      projectId: "zisa-spelletjesmaker-pro",
      storageBucket: "zisa-spelletjesmaker-pro.firebasestorage.app",
      messagingSenderId: "828063957776",
      appId: "1:828063957776:web:8d8686b478846fe980db95",
      measurementId: "G-9LHNLFHSXX"
    };

    // ------------------ imports ------------------
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import {
      getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import {
      getFunctions, httpsCallable
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-functions.js";

    // ------------------ init ------------------
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const functions = getFunctions(app, "europe-west1");
    const el = (id) => document.getElementById(id);
    const statusBox = el("status");
    const userLine = el("currentUser");
    const btnGoogle = el("btnGoogle");
    const btnLogout = el("btnLogout");

    // Hulpfuncties UI
    function showStatus(msg, kind="info"){
      statusBox.textContent = "";
      statusBox.classList.remove("hide","ok","err");
      if(kind==="ok") statusBox.classList.add("ok");
      if(kind==="err") statusBox.classList.add("err");
      statusBox.innerHTML = msg;
      statusBox.classList.remove("hide");
    }
    function hideStatus(){ statusBox.classList.add("hide"); }

    // Uniek apparaat-id (wordt 1x aangemaakt en hergebruikt)
    function getDeviceId(){
      const KEY = "zisa_device_id";
      let id = localStorage.getItem(KEY);
      if(!id){
        id = (self.crypto?.randomUUID?.() || String(Date.now())+Math.random().toString(16).slice(2));
        localStorage.setItem(KEY, id);
      }
      return id;
    }

    async function registerCurrentDevice(){
      const deviceId = getDeviceId();
      const call = httpsCallable(functions, "registerDevice");
      const res = await call({ deviceId });
      return res.data; // { ok, reason?, maxDevices?, expiresAt? }
    }

    async function handleLoginSuccess(user){
      userLine.textContent = `Ingelogd als ${user.email}`;
      showStatus(`Een ogenblikje… we activeren PRO op dit apparaat <span class="spinner"></span>`);
      try {
        const reg = await registerCurrentDevice();
        if (reg.ok) {
          // Klaar → door naar de app
          showStatus("PRO geactiveerd. U wordt doorgestuurd…", "ok");
          window.location.href = APP_URL;
          return;
        }
        // Afhandeling fouten
        if (reg.reason === "EXPIRED_SUBSCRIPTION") {
          showStatus("Uw PRO-abonnement is verlopen. Verlengen kan via uw bevestigingsmail of neem contact op.", "err");
        } else if (reg.reason === "DEVICE_LIMIT") {
          showStatus(`Apparaatlimiet bereikt (max ${reg.maxDevices || 2}). Verwijder een oud apparaat of neem contact op.`, "err");
        } else {
          showStatus("Kon PRO niet activeren. Probeer opnieuw of neem contact op.", "err");
        }
      } catch (e){
        console.error(e);
        showStatus("Er ging iets mis bij het activeren. Probeer opnieuw.", "err");
      }
    }

    // Auth events
    onAuthStateChanged(auth, (user) => {
      if (user) {
        btnLogout.classList.remove("hide");
        btnGoogle.disabled = true;
        handleLoginSuccess(user);
      } else {
        btnLogout.classList.add("hide");
        btnGoogle.disabled = false;
        userLine.textContent = "";
        hideStatus();
      }
    });

    // Knoppen
    btnGoogle.addEventListener("click", async () => {
      btnGoogle.disabled = true;
      btnGoogle.innerHTML = 'Inloggen… <span class="spinner"></span>';
      try {
        await signInWithPopup(auth, new GoogleAuthProvider());
      } catch (e){
        console.error(e);
        showStatus("Inloggen is afgebroken of mislukt. Probeer opnieuw.", "err");
        btnGoogle.disabled = false;
        btnGoogle.textContent = "Inloggen met Google";
      }
    });

    btnLogout.addEventListener("click", async () => {
      await signOut(auth);
      btnGoogle.textContent = "Inloggen met Google";
      showStatus("U bent uitgelogd.","ok");
    });
  </script>
</body>
</html>
