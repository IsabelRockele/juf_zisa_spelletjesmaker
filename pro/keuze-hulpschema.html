<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8">
  <base href="/juf_zisa_spelletjesmaker/pro/">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Kies Hulpschema</title>
  <link rel="stylesheet" href="../keuze-hulpschema.css">
</head>
<body>
  <div class="panel">
    <div id="stap1" class="stap">
      <a href="./app.html" class="menu-btn">Keuzemenu</a>
      <h1>Kies waarmee je wilt oefenen</h1>
      <div class="button-container">
        <button id="naar-stap2-btn" class="choice-btn">Tot 100</button>
      <a href="Tot_1000.html" class="choice-btn">Tot 1000</a>
        </div>
    </div>

    <div id="stap2" class="stap" style="display: none;">
      <button id="terug-naar-stap1-btn" class="menu-btn">Terug</button>
      <h1>Oefenen tot 100</h1>
      <div class="button-container">
        <a href="./plus100.html?terug=keuze-hulpschema.html#stap2" class="choice-btn plus">+</a>
        <a href="./min100.html?terug=keuze-hulpschema.html#stap2" class="choice-btn min">-</a>
      </div>
    </div>
  </div>

  <script>
    const stap1 = document.getElementById('stap1');
    const stap2 = document.getElementById('stap2');
    const naarStap2Btn = document.getElementById('naar-stap2-btn');
    const terugNaarStap1Btn = document.getElementById('terug-naar-stap1-btn');

    function toonJuisteStap() {
      if (window.location.hash === '#stap2') {
        stap1.style.display = 'none';
        stap2.style.display = 'block';
      } else {
        stap1.style.display = 'block';
        stap2.style.display = 'none';
      }
    }
    document.addEventListener('DOMContentLoaded', toonJuisteStap);

    naarStap2Btn.addEventListener('click', () => {
      stap1.style.display = 'none';
      stap2.style.display = 'block';
    });
    terugNaarStap1Btn.addEventListener('click', () => {
      stap2.style.display = 'none';
      stap1.style.display = 'block';
      history.pushState("", document.title, window.location.pathname + window.location.search);
    });
  </script>

  <!-- PRO init eerst -->
  <script src="./device-id.js"></script>
  <script type="module" src="./guard.js"></script>

  <!-- QR-paneel voor leerkracht (compact, rechtsonder) -->
<!-- QR-paneel voor leerkracht (compact, rechtsonder) -->
<div id="kid-qr-panel" style="
  position:fixed; right:14px; bottom:14px; z-index:9999;
  background:#fff; border:1px solid #e3e8f5; border-radius:12px;
  box-shadow:0 6px 20px rgba(0,0,0,.08); padding:12px; width: 280px;">
  <div style="font:600 14px system-ui; color:#123b72; margin-bottom:8px;">
    QR voor de kinderen
  </div>
  <button id="gen-qr"
    style="width:100%; padding:10px; border-radius:9px; border:2px solid #3f7fbf; background:#fff; color:#275ea8; font-weight:800; cursor:pointer;">
    Maak QR
  </button>

  <div id="qr-wrap" style="display:none; margin-top:10px; text-align:center;">
    <div id="qr-box" style="display:inline-block; padding:6px; background:#fff; border:1px solid #eef3ff;"></div>
    <a id="qr-dl" download="hulpschema-qr.png"
       style="display:block; margin-top:8px; font:600 13px system-ui; color:#275ea8; text-decoration:underline; cursor:pointer;">
       Download als PNG
    </a>
    <div id="qr-exp" style="margin-top:6px; font:12px system-ui; color:#566;">
      Geldig t/m: …
    </div>
  </div>

  <!-- ⬇️ UITLEG HIER PLAKKEN (onder het QR-blok) -->
  <div id="qr-uitleg" style="display:none; margin-top:8px; font-size:0.95rem; line-height:1.35;">
    <strong>Tip voor leerkrachten</strong><br>
    Druk de QR-code af en hang ze zichtbaar op in de klas en/of kleef ze in de klasagenda.<br>
    De QR werkt zolang je PRO-toegang actief is.<br>
    (Een nieuwe QR aanmaken maakt de vorige <em>niet</em> onbruikbaar.)
  </div>
</div>


    <!-- QR generator lib (lichtgewicht) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js" defer></script>
  <!-- jsPDF voor PDF-export -->
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

  <!-- QR & PDF logica — NA guard.js! -->
  <script type="module">
    // Zelfde Firebase versie als guard.js
    import { getApps } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getFunctions, httpsCallable } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-functions.js";

    const sleep = (ms)=>new Promise(r=>setTimeout(r,ms));
    async function waitReady(maxMs=12000){
      const t0 = Date.now();
      while (!getApps().length && Date.now()-t0 < maxMs) { await sleep(100); }
      return getApps().length > 0;
    }

    // Hoge-res QR (PNG dataURL) — gebruikt door PDF
    function makeQrDataUrl(text, sizePx = 900) {
      return new Promise((resolve) => {
        const tmp = document.createElement('div');
        tmp.style.position = 'fixed';
        tmp.style.left = '-10000px';
        document.body.appendChild(tmp);

        new QRCode(tmp, { text, width: sizePx, height: sizePx, correctLevel: QRCode.CorrectLevel.M });

        setTimeout(() => {
          const img = tmp.querySelector('img');
          const canvas = tmp.querySelector('canvas');
          const dataUrl = img?.src || canvas?.toDataURL('image/png') || '';
          document.body.removeChild(tmp);
          resolve(dataUrl);
        }, 30);
      });
    }

    // PDF: A4 liggend, 2 kolommen × 5 rijen; elk in een eigen vak, titel erboven
 async function makePdfFromQr(url, copies = 20) {
  if (!url) return;
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({ orientation: 'landscape', unit: 'mm', format: 'a4' });

  // A4 liggend
  const pageW = 297, pageH = 210;

  // Raster: 3 kolommen × 3 rijen  →  9 kaartjes per pagina
  const margin   = 10;
  const cols     = 3;
  const rows     = 3;
  const gutterX  = 8;    // ruimte tussen kolommen
  const gutterY  = 10;   // ruimte tussen rijen

  // Kaart/vak afmetingen
  const cardW = (pageW - 2*margin - gutterX*(cols-1)) / cols;   // ≈ 87 mm
  const cardH = (pageH - 2*margin - gutterY*(rows-1)) / rows;   // ≈ 56.7 mm

  const title = 'Hulpschema rekenen';

  // Binnenmarges in elk vak (ruim genoeg voor volledige QR)
  const padTop    = 5;   // boven de titel
  const padSides  = 6;   // links/rechts
  const padUnderT = 2;   // tussen titel en QR
  const padBottom = 5;   // onderaan

  // Titelhoogte (visueel) in mm – we tekenen met fontSize in pt,
  // maar rekenen hier met een conservatieve 4.5 mm voor de zone.
  const titleZone = 4.5;

  // Beschikbare ruimte voor QR
  const availW = cardW - 2*padSides;                                   // ≈ 75 mm
  const availH = cardH - padTop - titleZone - padUnderT - padBottom;   // ≈ 40+ mm

  // Veiligheidsmarge zodat QR nooit “aanraakt”
  const safety  = 1.5; // mm

  // QR-maat: zo groot mogelijk, maar netjes binnen het vak
  // 34–44 mm scant comfortabel; we kiezen de min van breedte/hoogte minus safety.
  const qrSize  = Math.max(34, Math.min(44, Math.min(availW, availH) - safety));

  // Eén hoge-res QR genereren en hergebruiken
  const qrPng = await makeQrDataUrl(url, 1000);

  // Bovenaan elke pagina een korte instructie
  const instruct = "Druk af (liggend, 3 kolommen). Hang op in de klas of kleef in de agenda. QR blijft een schooljaar geldig.";
  const drawPageHeader = () => {
    doc.setFont('helvetica','normal');
    doc.setFontSize(9);
    doc.text(instruct, pageW/2, 7, { align: 'center' });
  };
  drawPageHeader();

  // Vakken tekenen
  doc.setDrawColor(60);
  doc.setLineWidth(0.25);

  for (let i = 0; i < copies; i++) {
    if (i > 0 && i % (cols*rows) === 0) {
      doc.addPage();
      drawPageHeader();
      doc.setDrawColor(60);
      doc.setLineWidth(0.25);
    }

    const slot = i % (cols*rows);
    const r = Math.floor(slot / cols);
    const c = slot % cols;

    const x = margin + c * (cardW + gutterX);
    const y = margin + r * (cardH + gutterY);
    const centerX = x + cardW / 2;

    // 1) Vak (wit + rand)
    doc.setFillColor(255,255,255);
    doc.rect(x, y, cardW, cardH, 'FD');

    // 2) Titel
    doc.setFont('helvetica','bold');
    doc.setFontSize(11);
    const titleY = y + padTop + 3.2; // ≈ baselinepositie zodat er ruimte boven/onder is
    doc.text(title, centerX, titleY, { align: 'center' });

    // 3) QR (gecentreerd)
    const qrX = centerX - qrSize / 2;
    const qrY = y + padTop + titleZone + padUnderT;
    doc.addImage(qrPng, 'PNG', qrX, qrY, qrSize, qrSize);
  }

  doc.save('hulpschema-qr.pdf');
}

    // UI-koppeling
    window.addEventListener('load', () => {
      const btn   = document.getElementById("gen-qr");
      const wrap  = document.getElementById("qr-wrap");
      const box   = document.getElementById("qr-box");
      const dl    = document.getElementById("qr-dl");
      const exp   = document.getElementById("qr-exp");
      const uitleg= document.getElementById("qr-uitleg");

      if (!btn || !wrap || !box) return;

      // PDF-knop bij het QR-panel toevoegen (éénmalig)
      let pdfBtn = document.getElementById('qr-pdf');
      if (!pdfBtn) {
        pdfBtn = document.createElement('button');
        pdfBtn.id = 'qr-pdf';
        pdfBtn.textContent = 'Download als PDF (3 kolommen)';
        pdfBtn.style.cssText = 'width:100%; margin-top:8px; padding:10px; border-radius:9px; border:2px solid #3f7fbf; background:#fff; color:#275ea8; font-weight:800; cursor:pointer;';
        pdfBtn.disabled = true;
        wrap.appendChild(pdfBtn);
      }

      let lastUrl = null;

      btn.addEventListener("click", async () => {
        const prev = btn.textContent;
        btn.disabled = true; btn.textContent = "Bezig…";
        try {
          const ready = await waitReady();
          if (!ready) { btn.textContent = "Niet gelukt"; console.error('Firebase niet klaar'); return; }
          if (typeof window.QRCode !== 'function') { alert('QR-bibliotheek niet geladen.'); return; }

          const fns = getFunctions(undefined, "europe-west1");
          const createKidLink = httpsCallable(fns, "createKidLink");
          const { data } = await createKidLink({ target: "kid-start", range: "100" });
          if (!data || !data.url) throw new Error('Onverwachte response (geen url).');

          lastUrl = data.url;

          wrap.style.display = "block";
          box.innerHTML = "";
          new QRCode(box, { text: data.url, width: 220, height: 220, correctLevel: QRCode.CorrectLevel.M });

          // PNG-download
          setTimeout(() => {
            const img = box.querySelector("img"); if (!img) return;
            const c = document.createElement("canvas");
            c.width = img.width; c.height = img.height;
            const ctx = c.getContext("2d");
            ctx.fillStyle = "#fff"; ctx.fillRect(0,0,c.width,c.height);
            const ph = new Image(); ph.crossOrigin = "anonymous";
            ph.onload = () => { ctx.drawImage(ph, 0, 0); dl.href = c.toDataURL("image/png"); };
            ph.src = img.src;
          }, 80);

          if (exp && data.expiresAt) {
            exp.textContent = "Geldig t/m: " + new Date(data.expiresAt).toLocaleDateString("nl-BE");
          }
          if (uitleg) uitleg.style.display = 'block';
          pdfBtn.disabled = false;

        } catch (e) {
          console.error(e);
          alert("Kon geen QR maken: " + (e.message || e));
        } finally {
          btn.textContent = prev; btn.disabled = false;
        }
      });

      // PDF-download
      pdfBtn.addEventListener('click', async () => {
        if (!lastUrl) { alert('Maak eerst een QR.'); return; }
        const n = parseInt(prompt('Voor hoeveel leerlingen kaartjes nodig?', '20') || '20', 10);
        await makePdfFromQr(lastUrl, (isFinite(n) && n > 0) ? n : 20);
      });
    });
  </script>
</body>
</html>
