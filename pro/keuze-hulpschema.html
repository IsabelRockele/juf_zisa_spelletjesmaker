<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8">
  <base href="/juf_zisa_spelletjesmaker/pro/">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Kies Hulpschema</title>
  <link rel="stylesheet" href="../keuze-hulpschema.css">
</head>
<body>
  <div class="panel">
    <div id="stap1" class="stap">
      <a href="index.html" class="menu-btn">Keuzemenu</a>
      <h1>Kies waarmee je wilt oefenen</h1>
      <div class="button-container">
        <button id="naar-stap2-btn" class="choice-btn">Tot 100</button>
      <a href="Tot_1000.html" class="choice-btn">Tot 1000</a>
        </div>
    </div>

    <div id="stap2" class="stap" style="display: none;">
      <button id="terug-naar-stap1-btn" class="menu-btn">Terug</button>
      <h1>Oefenen tot 100</h1>
      <div class="button-container">
        <a href="./plus100.html?terug=keuze-hulpschema.html#stap2" class="choice-btn plus">+</a>
        <a href="./min100.html?terug=keuze-hulpschema.html#stap2" class="choice-btn min">-</a>
      </div>
    </div>
  </div>

  <script>
    const stap1 = document.getElementById('stap1');
    const stap2 = document.getElementById('stap2');
    const naarStap2Btn = document.getElementById('naar-stap2-btn');
    const terugNaarStap1Btn = document.getElementById('terug-naar-stap1-btn');

    function toonJuisteStap() {
      if (window.location.hash === '#stap2') {
        stap1.style.display = 'none';
        stap2.style.display = 'block';
      } else {
        stap1.style.display = 'block';
        stap2.style.display = 'none';
      }
    }
    document.addEventListener('DOMContentLoaded', toonJuisteStap);

    naarStap2Btn.addEventListener('click', () => {
      stap1.style.display = 'none';
      stap2.style.display = 'block';
    });
    terugNaarStap1Btn.addEventListener('click', () => {
      stap2.style.display = 'none';
      stap1.style.display = 'block';
      history.pushState("", document.title, window.location.pathname + window.location.search);
    });
  </script>

  <!-- PRO init eerst -->
  <script src="./device-id.js"></script>
  <script type="module" src="./guard.js"></script>

  <!-- QR-paneel voor leerkracht (compact, rechtsonder) -->
  <div id="kid-qr-panel" style="
    position:fixed; right:14px; bottom:14px; z-index:9999;
    background:#fff; border:1px solid #e3e8f5; border-radius:12px;
    box-shadow:0 6px 20px rgba(0,0,0,.08); padding:12px; width: 280px;">
    <div style="font:600 14px system-ui; color:#123b72; margin-bottom:8px;">
      QR voor thuisgebruik
    </div>
    <button id="gen-qr"
      style="width:100%; padding:10px; border-radius:9px; border:2px solid #3f7fbf; background:#fff; color:#275ea8; font-weight:800; cursor:pointer;">
      Maak QR
    </button>
    <div id="qr-wrap" style="display:none; margin-top:10px; text-align:center;">
      <div id="qr-box" style="display:inline-block; padding:6px; background:#fff; border:1px solid #eef3ff;"></div>
      <a id="qr-dl" download="hulpschema-qr.png"
         style="display:block; margin-top:8px; font:600 13px system-ui; color:#275ea8; text-decoration:underline; cursor:pointer;">
         Download als PNG
      </a>
      <div id="qr-exp" style="margin-top:6px; font:12px system-ui; color:#566;">
        Geldig t/m: …
      </div>
    </div>
  </div>

    <!-- QR generator lib (lichtgewicht) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js" defer></script>
  <!-- jsPDF voor PDF-export -->
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

  <!-- Aanroep naar je Cloud Function 'createKidLink' — NA guard.js! -->
  <script type="module">
    // Let op: versie 10.12.2 — gelijk aan guard.js
    import { getApps } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getFunctions, httpsCallable } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-functions.js";

    // PDF helpers
    const sleep = (ms)=>new Promise(r=>setTimeout(r,ms));
    async function waitReady(maxMs=12000){
      const t0 = Date.now();
      while (!getApps().length && Date.now()-t0 < maxMs) { await sleep(100); }
      return getApps().length > 0;
    }

    // Hoge-res QR als dataURL (PNG) — één keer genereren en hergebruiken
    function makeQrDataUrl(text, sizePx = 800) {
      return new Promise((resolve) => {
        const tmp = document.createElement('div');
        tmp.style.position = 'fixed';
        tmp.style.left = '-10000px';
        document.body.appendChild(tmp);

        new QRCode(tmp, { text, width: sizePx, height: sizePx, correctLevel: QRCode.CorrectLevel.M });

        setTimeout(() => {
          const img = tmp.querySelector('img');
          const canvas = tmp.querySelector('canvas');
          const dataUrl = img?.src || canvas?.toDataURL('image/png') || '';
          document.body.removeChild(tmp);
          resolve(dataUrl);
        }, 30);
      });
    }

    async function makePdfFromQr(url, copies = 20) {
      if (!url) return;
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({ orientation: 'landscape', unit: 'mm', format: 'a4' });

      // A4 landscape: 297 × 210 mm
      const pageW = 297, pageH = 210;
      const margin = 10;
      const cols = 2, rows = 5;          // 2 kolommen × 5 rijen = 10 kaartjes/pagina
      const colGap = 10;
      const colW = (pageW - 2*margin - colGap) / cols;
      const rowStep = (pageH - 2*margin) / rows;
      const title = 'Hulpschema rekenen';
      const qrSize = 42;                 // ≈ 42 mm: goed scanbaar, niet reusachtig

      const qrPng = await makeQrDataUrl(url, 900);

      for (let i = 0; i < copies; i++) {
        if (i > 0 && i % (cols*rows) === 0) doc.addPage();

        const slot = i % (cols*rows);
        const r = Math.floor(slot / cols);
        const c = slot % cols;

        const colX = margin + c * (colW + colGap);
        const yTop = margin + r * rowStep;
        const centerX = colX + colW / 2;

        // Titel
        doc.setFont('helvetica', 'bold');
        doc.setFontSize(12);
        doc.text(title, centerX, yTop + 5, { align: 'center' });

        // QR
        const xImg = centerX - qrSize / 2;
        const yImg = yTop + 8;
        doc.addImage(qrPng, 'PNG', xImg, yImg, qrSize, qrSize);
      }

      doc.save('hulpschema-qr.pdf');
    }

    window.addEventListener('load', () => {
      const btn  = document.getElementById("gen-qr");
      const wrap = document.getElementById("qr-wrap");
      const box  = document.getElementById("qr-box");
      const dl   = document.getElementById("qr-dl");
      const exp  = document.getElementById("qr-exp");

      // PDF-knop toevoegen (in je bestaande panel)
      let pdfBtn = document.getElementById('qr-pdf');
      if (!pdfBtn) {
        pdfBtn = document.createElement('button');
        pdfBtn.id = 'qr-pdf';
        pdfBtn.textContent = 'Download als PDF (2 kolommen)';
        pdfBtn.style.cssText = 'width:100%; margin-top:8px; padding:10px; border-radius:9px; border:2px solid #3f7fbf; background:#fff; color:#275ea8; font-weight:800; cursor:pointer;';
        pdfBtn.disabled = true; // wordt pas actief na QR
        wrap.appendChild(pdfBtn);
      }

      if (!btn) return;

      let lastUrl = null; // onthoud de laatste QR-URL voor PDF

      btn.addEventListener("click", async () => {
        const prev = btn.textContent;
        btn.disabled = true; btn.textContent = "Bezig…";
        try {
          const ready = await waitReady();
          if (!ready) { btn.textContent = "Niet gelukt"; return; }

          const fns = getFunctions(undefined, "europe-west1");
          const createKidLink = httpsCallable(fns, "createKidLink");
          const { data } = await createKidLink({ target: "kid-start", range: "100" });

          lastUrl = data.url;                 // << nodig voor PDF
          wrap.style.display = "block";
          box.innerHTML = "";
          new QRCode(box, { text: data.url, width: 220, height: 220, correctLevel: QRCode.CorrectLevel.M });

          // Download als PNG
          setTimeout(() => {
            const img = box.querySelector("img"); if (!img) return;
            const c = document.createElement("canvas");
            c.width = img.width; c.height = img.height;
            const ctx = c.getContext("2d");
            ctx.fillStyle = "#fff"; ctx.fillRect(0,0,c.width,c.height);
            const ph = new Image(); ph.crossOrigin = "anonymous";
            ph.onload = () => { ctx.drawImage(ph, 0, 0); dl.href = c.toDataURL("image/png"); };
            ph.src = img.src;
          }, 80);

          exp.textContent = "Geldig t/m: " + new Date(data.expiresAt).toLocaleDateString("nl-BE");
          pdfBtn.disabled = false;            // PDF-knop activeren
        } catch (e) {
          alert("Kon geen QR maken: " + (e.message || e));
        } finally {
          btn.textContent = prev; btn.disabled = false;
        }
      });

      // PDF-knop: vraag aantal kaartjes (default 20 = 2 pagina’s)
      pdfBtn.addEventListener('click', async () => {
        if (!lastUrl) { alert('Maak eerst een QR.'); return; }
        const n = parseInt(prompt('Aantal kaartjes (10 per pagina)?', '20') || '20', 10);
        await makePdfFromQr(lastUrl, (isFinite(n) && n > 0) ? n : 20);
      });
    });
  </script>
</body>
</html>
