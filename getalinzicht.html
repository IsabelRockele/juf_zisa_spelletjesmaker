<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Werkblad-generator v9.2.9 – Finale Versie</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    html,body{height:100%;margin:0;font:15px/1.35 system-ui,Segoe UI,Roboto,Arial,sans-serif;background:#fffdfa;color:#222}
    header{position:sticky;top:0;background:#fff;border-bottom:1px solid #d9e2ec;z-index:10}
    .wrap{max-width:1060px;margin:0 auto;padding:14px}
    .layout{display:grid;grid-template-columns:1fr 1.5fr;gap:16px;align-items:start}
    fieldset{border:1px solid #d9e2ec;border-radius:10px;padding:10px;background:#fff;margin-bottom:12px}
    legend{padding:0 6px;color:#334;font-weight:600}
    label{display:inline-flex;align-items:center;gap:8px;margin:4px 10px 4px 0}
    input[type=number],input[type=text],select{border:1px solid #d9e2ec;border-radius:9px;padding:5px 9px;font-size:14px}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-bottom:6px}
    .btn{appearance:none;border:1px solid #1e88e5;background:#1e88e5;color:#fff;border-radius:999px;padding:7px 12px;cursor:pointer;font-weight:600}
    .btn.ghost{background:#fff;color:#1e88e5}
    .btn.ghost:hover{box-shadow: inset 0 0 0 2px #1e88e5;}
    #previewBox{border:1px solid #d9e2ec;border-radius:12px;background:#eef6ff;padding:12px}
    #previewSvg{display:block;width:100%;height:160px}
    #sheet{border:1px solid #d9e2ec;border-radius:12px;background:#fff;padding:14px}
    .sheetHeader{margin:4px 0 8px 0; border-bottom: 2px solid #334; padding-bottom: 8px;}

    /* Opdrachtblokken */
    .exercise, .jump-exercise-block, .mixed-exercise-block, .sequence-exercise-block, .honderdveld-exercise-block, .mab-exercise-block {
      position:relative;margin:14px 0 20px 0;padding:10px 12px 20px 12px;border:1px solid #d9e2ec;border-radius:10px;background:#fff;page-break-inside: avoid;overflow: visible;
    }
    .exercise-title{font-weight:600;color:#334;margin:0 0 8px 0;font-size:15px; page-break-after: avoid;}
    .delete-btn{position:absolute;top:0;right:0;width:22px;height:22px;border:1px solid #e57373;background:#fff;color:#e57373;border-radius:50%;cursor:pointer;font-size:14px;line-height:20px;text-align:center;font-weight:bold;z-index:5}
    
    /* Honderdveld */
    .honderdveld-container{display:flex;align-items:center;gap:16px; flex-wrap: wrap;}
    .honderdveld-grid{display:grid;grid-template-columns:repeat(10, 20px);grid-template-rows:repeat(10, 20px);border-top:1px solid #ccc;border-left:1px solid #ccc;width:201px;height:201px;box-sizing:content-box; flex-shrink: 0;}
    .honderdveld-cell{border-right:1px solid #ccc;border-bottom:1px solid #ccc;box-sizing:border-box}
    .honderdveld-cell.filled-ten { background-color: #4caf50; }
    .honderdveld-cell.filled-unit { background-color: #ffeb3b; }
    .honderdveld-cell:nth-child(10n+5){border-right:2px solid #334}
    .honderdveld-cell:nth-child(n+41):nth-child(-n+50){border-bottom:2px solid #334}
    .honderdveld-task{display:flex;align-items:center;gap:12px}
    .honderdveld-te-table{border-collapse:collapse;text-align:center;font-weight:bold}
    .honderdveld-te-table td{border:1px solid #334;width:40px;height:36px}
    .honderdveld-te-table input{width:100%;height:100%;border:none;text-align:center;font:inherit;font-weight:bold;font-size:16px;box-sizing:border-box}
    .honderdveld-num-box{width: 50px; height: 44px; border:2px solid #c9d6ea;border-radius:9px;text-align:center;font:inherit;font-size:16px;font-weight:bold}
    .honderdveld-row { display: flex; gap: 16px; align-items: flex-start; page-break-inside: avoid; }
    .honderdveld-row > .honderdveld-exercise-block { flex: 1; margin-top: 0; }
    .aanvul-vragen{display:flex;flex-direction:column;gap:10px; font-size: 16px;}
    .aanvul-rij{display:flex;align-items:center;gap:6px;white-space:nowrap;}
    .aanvul-input{width:40px;height:30px;border:1px solid #ccc; border-radius: 6px; text-align:center; font:inherit; font-size:15px;}

    /* MAB Materiaal */
    .mab-grid-layout{display:grid; grid-template-columns: 1fr 1fr; gap: 20px;}
    .mab-grid-layout > * { min-height: 280px; align-items: flex-start;} /* Zorgt voor gelijke hoogte */
    .mab-tellen-container{display:flex; flex-direction:column; align-items:center; gap: 8px;}
    .mab-labeled-container{display:flex; border: 1.5px solid #334; border-radius: 4px;}
    .mab-column{display:flex; flex-direction:column; align-items:center; padding: 4px;}
    .mab-column-tens{ border-right: 1.5px solid #334; }
    .mab-header{font-weight:bold; font-size:18px; margin-bottom:4px; min-height: 22px; width: 100%; text-align: center; border-bottom: 1.5px solid #334; padding-bottom: 4px;}
    .mab-blocks-wrapper{display:flex; flex-wrap:wrap; gap:4px; min-height:170px; align-content: flex-start; padding-top: 4px;}
    .mab-tens-wrapper { width:96px;}
    .mab-units-wrapper{width:96px;}
    .mab-blocks-wrapper svg{height: 80px;}
    .mab-blocks-wrapper svg.unit{height: 16px; width: 16px;}
    .mab-te-table{border-collapse:collapse;text-align:center;font-weight:bold; margin-top: 8px;}
    .mab-te-table td{border:1px solid #334;width:44px;height:40px}
    .mab-te-table .te-label{background-color:#4caf50; color:white; font-size:18px;}
    .mab-te-table .te-label.e{background-color:#ffeb3b; color:#333;}
    .mab-te-table input{width:100%;height:100%;border:none;text-align:center;font:inherit;font-weight:bold;font-size:18px;box-sizing:border-box}
    .mab-connect-layout{display:flex; justify-content:space-between; align-items:center; gap:20px;}
    .mab-connect-col{display:flex; flex-direction:column; gap: 40px;}
    .mab-connect-row{display:flex; align-items:center; gap:8px;}
    .mab-connect-item{border: 1px solid #d9e2ec; border-radius: 8px; padding: 10px;}
    .connect-dot{width:10px; height:10px; background-color:black; border-radius:50%;}
    .mab-connect-num{font-size:24px; font-weight:bold; border:2px solid #ccc; border-radius:10px; width:60px; height:50px; display:flex; justify-content:center; align-items:center;}
    .mab-color-layout{display:flex; align-items:center; gap:20px;}
    .mab-color-num{font-size:36px;font-weight:bold;min-width:60px;text-align:center}

    /* Andere stijlen */
    .menu-btn{ position:fixed; top:10px; left:10px; z-index:20; display:inline-block; padding:8px 14px; border-radius:999px; background:#0d47a1; color:#fff; text-decoration:none; font-weight:700; border:1px solid #0a3a85; } .menu-btn:focus{outline:2px solid #fff; outline-offset:2px}
    .exercise.drag{ padding-bottom:36px; } .exercise svg{display:block;width:100%;height:220px;} .exercise.drag svg { margin-top:12px } .exercise.blanks svg { margin-top:22px } .card{position:absolute;display:flex;align-items:center;justify-content:center;width:52px;height:44px;border-radius:10px;border:2px solid #c9d6ea;background:#fff;box-shadow:0 3px 8px rgba(0,0,0,.06);font-weight:700} .card::before{content:'';position:absolute;top:-7px;left:50%;transform:translateX(-50%);width:7px;height:7px;background:#111;border-radius:50%} .print-overlay-input{ position:absolute; background:transparent; }
    .jump-exercise{padding:12px 8px 8px 8px} .jump-row{display:inline-grid;grid-auto-flow:column;grid-auto-columns:max-content;align-items:center;gap:8px} .jump-start,.jump-given{font-weight:bold;font-size:17px;padding:5px;border:2px solid #6b879a;border-radius:9px;background:#eef6ff;text-align:center;min-width:46px;box-sizing:border-box} .jump-box{width:46px;height:34px;border:2px solid #c9d6ea;border-radius:9px;font-family:inherit;font-size:15px;text-align:center;padding:0} .jump-arc-wrapper{position:relative;height:28px} .jump-arcs-inline{display:block;height:28px;overflow:visible;margin:0} .jump-arcs-inline path{fill:none;stroke:#1e88e5;stroke-width:2} .arc-labels{position:absolute;left:0;top:0;width:100%;height:28px;pointer-events:none} .arc-label{position:absolute;transform:translateX(-50%);top:-14px;font-weight:700;font-size:12px;color:#1e88e5;white-space:nowrap}
    .mixed-grid{display:grid;grid-template-columns: repeat(3, minmax(0,1fr));gap:8px 10px} .mix-item{display:flex;align-items:center;justify-content:center;gap:6px;padding:6px;border:1px dashed #d9e2ec;border-radius:9px;min-height:54px;overflow:hidden;white-space:nowrap} .mix-num{font-weight:700;font-size:17px;min-width:34px;text-align:center} .mix-label{font-weight:700;font-size:16px} .mix-eq{font-weight:700;margin:0 2px} .mix-box{width:52px;height:34px;border:2px solid #c9d6ea;border-radius:9px;text-align:center;font:inherit;box-sizing:border-box} .mix-box.small{width:40px}
    .seq-row{display:flex;gap:8px;flex-wrap:nowrap;align-items:center;padding:8px 4px} .seq-num{min-width:42px;text-align:center;font-weight:700} .seq-box{width:52px;height:34px;border:2px solid #c9d6ea;border-radius:9px;text-align:center;font:inherit;box-sizing:border-box}
    
    @media print{ header,#controls,#previewTitle,.delete-btn{display:none !important} #sheet{border:0;padding:0} .print-overlay-input{ display:none !important; } }
    @page{ margin:12mm 12mm 12mm 22mm; }
  </style>
</head>
<body>
  <a class="menu-btn" href="index.html">Keuzemenu</a>

<header>
  <div class="wrap"><h1>Werkblad-generator</h1></div>
</header>

<main class="wrap layout">
  <section id="controls">
    <fieldset>
      <legend>1. Getallenlijn Instellen</legend>
      <fieldset><legend>Bereik</legend>
        <div class="row">
          <label><input type="radio" name="preset" value="0-10"> 0-10</label>
          <label><input type="radio" name="preset" value="0-20"> 0-20</label>
          <label><input type="radio" name="preset" value="0-100"> 0-100</label>
        </div>
        <div class="row">
          <label>Van <input id="start" type="number" value="0" style="width:68px"></label>
          <label>Tot <input id="end" type="number" value="100" style="width:68px"></label>
          <label>Stap <input id="unit" type="number" value="1" min="1" style="width:48px"></label>
        </div>
      </fieldset>
      <fieldset><legend>Labels en streepjes</legend>
        <div class="row">
          <label><input id="showZero" type="checkbox" checked> 0 tonen</label>
          <label><input id="showEnds" type="checkbox" checked> Uiteinden</label>
        </div>
        <div class="row">
          <label><input id="showTens" type="checkbox" checked> Tientallen</label>
          <label><input id="showFives" type="checkbox"> Vijftallen</label>
          <label><input id="showOnes" type="checkbox"> Eenheden</label>
        </div>
        <div class="row">
          <label>Grote streep bij
            <select id="majorStep" style="width:68px">
              <option value="10">10</option>
              <option value="5">5</option>
              <option value="1">1</option>
            </select>
          </label>
        </div>
      </fieldset>
      <fieldset><legend>Opdracht</legend>
        <div class="row">
          <label><input type="radio" name="mode" value="none" checked> Geen</label>
          <label><input type="radio" name="mode" value="drag"> Verbind getallen</label>
          <label><input type="radio" name="mode" value="blanks"> Vul hokjes in</label>
        </div>
        <div id="mode-drag" style="display:none">
          <label>Getallen <input id="dragList" type="text" value="" style="width:100%"></label>
        </div>
        <div id="mode-blanks" style="display:none">
          <label>Aantal lege hokjes <input id="blankCount" type="number" value="5" min="1" style="width:56px"></label>
        </div>
      </fieldset>
      <div class="row"><button class="btn" id="btnAddToSheet" type="button">Voeg getallenlijn toe</button></div>
    </fieldset>

    <fieldset>
      <legend>2. Sprongen Tellen</legend>
      <div class="row">
        <label>Startgetal <input id="jumpStart" type="number" value="31" style="width:74px"></label>
        <label>Sprong van <input id="jumpStep" type="number" value="10" style="width:74px"></label>
        <label>Aantal hokjes <input id="jumpCount" type="number" value="5" min="1" max="12" style="width:74px"></label>
      </div>
      <div class="row" style="border-top:1px solid #d9e2ec;margin-top:6px;padding-top:6px">
        <label><input id="jumpDiscover" type="checkbox"> Laat de sprong ontdekken</label>
      </div>
      <div id="jumpDiscoverOptions" style="display:none">
        <div class="row">
          <label>Aantal ingevuld <input id="jumpGivenCount" type="number" value="2" min="0" style="width:64px"></label>
          <label>Vaste posities (1..N, komma’s) <input id="jumpGivenPositions" type="text" placeholder="bv. 1,3,5" style="width:160px"></label>
        </div>
        <div class="row">
          <label><input id="jumpIncludeStart" type="checkbox" checked> Start invullen</label>
          <label><input id="jumpIncludeEnd" type="checkbox"> Eind invullen</label>
        </div>
      </div>
      <button class="btn" id="btnAddJumpExercise" type="button">Voeg sprong-oefening toe</button>
    </fieldset>

    <fieldset>
      <legend>3. Gemengde Rekoefeningen</legend>
      <div class="row">
        <label>Soort:
          <select id="mixedType" style="width:260px">
            <option value="neighbors">Buurgetallen</option>
            <option value="neighborTens">Buurtientallen</option>
            <option value="composeTE">Vul het getal in (T/E → getal)</option>
            <option value="compare">Vergelijken (getal ↔ getal)</option>
            <option value="compareTE">Vergelijken (T/E ↔ getal/T&E)</option>
          </select>
        </label>
      </div>
      <div class="row">
        <label>Getallen tot <input id="mixedMax" type="number" value="100" style="width:74px"></label>
        <label>Aantal <input id="mixedCount" type="number" value="9" min="1" max="60" style="width:74px"></label>
      </div>
      <button class="btn" id="btnAddMixed" type="button">Voeg oefeningen toe</button>
    </fieldset>

    <fieldset>
      <legend>4. Getallenrij (vooruit/achteruit)</legend>
      <div class="row">
        <label>Start <input id="seqStart" type="number" value="22" style="width:74px"></label>
        <label>Eind <input id="seqEnd" type="number" value="40" style="width:74px"></label>
        <label>Aantal lege hokjes <input id="seqBlankCount" type="number" value="5" min="0" style="width:74px"></label>
      </div>
      <div class="row">
        <label><input id="seqLockEnds" type="checkbox" checked> Start en eind vooraf invullen</label>
      </div>
      <button class="btn" id="btnAddSequence" type="button">Voeg getallenrij toe</button>
    </fieldset>
    
    <fieldset>
        <legend>5. Honderdveld</legend>
        <div class="row">
            <label>Soort:
              <select id="honderdveldType" style="width:260px">
                <option value="veld-naar-getal">Veld → Getal (inkvullen)</option>
                <option value="getal-naar-veld">Getal → Veld (kleuren)</option>
                <option value="aanvullen-tiental">Aanvullen tot volgend tiental</option>
              </select>
            </label>
        </div>
        <div class="row">
            <label>Getallen tot <input id="honderdveldMax" type="number" value="100" min="1" max="100" style="width:74px"></label>
            <label>Aantal <input id="honderdveldCount" type="number" value="2" min="1" max="20" style="width:74px"></label>
        </div>
        <div class="row" style="border-top:1px solid #d9e2ec;margin-top:6px;padding-top:6px">
             <label><input id="honderdveldTwoColumns" type="checkbox"> 2 oefeningen per rij</label>
        </div>
        <button class="btn" id="btnAddHonderdveld" type="button">Voeg honderdveld-oefening toe</button>
    </fieldset>

    <fieldset>
        <legend>6. MAB-Materiaal (blokken)</legend>
        <div class="row">
            <label>Soort:
              <select id="mabType" style="width:260px">
                <option value="tellen">Hoeveel tel je? (invullen)</option>
                <option value="verbinden">Wat is evenveel? (verbinden)</option>
                <option value="kleuren">Kleur de hoeveelheid</option>
              </select>
            </label>
        </div>
        <div class="row">
            <label>Getallen tot <input id="mabMax" type="number" value="99" min="1" max="99" style="width:74px"></label>
            <label>Aantal <input id="mabCount" type="number" value="4" min="1" max="10" style="width:74px"></label>
        </div>
        <button class="btn" id="btnAddMab" type="button">Voeg MAB-oefening toe</button>
    </fieldset>

    <div style="margin-top:18px">
      <button class="btn ghost" id="btnDownloadPdf" type="button">Download als PDF</button>
      <button class="btn ghost" id="btnClearSheet" type="button">Werkblad leegmaken</button>
    </div>
  </section>

  <section>
    <h3 id="previewTitle" style="margin:6px 0 6px 0;color:#334">Voorbeeld Getallenlijn</h3>
    <div id="previewBox"><svg id="previewSvg" viewBox="0 0 1000 150" xmlns="http://www.w3.org/2000/svg"></svg></div>
    <h3 style="margin:14px 0 6px 0;color:#334">Werkblad</h3>
    <div id="sheet"></div>
  </section>
</main>

<script>
(function(){
  if (window.__WG_V929_BOUND__) return;
  window.__WG_V929_BOUND__ = true;

  const $  = s => document.querySelector(s);
  const $$ = s => Array.from(document.querySelectorAll(s));
  const sheet = $('#sheet');
  const previewSvg = $('#previewSvg');
  const NS = 'http://www.w3.org/2000/svg';

  const PAD_L = 40;
  const PAD_R = 30;

  let addedTitles = new Set();
  function ensureTitleOnce(container, key, text){
    if (!addedTitles.has(key)) {
      const h = document.createElement('h4');
      h.className = 'exercise-title';
      h.dataset.titleKey = key;
      h.textContent = text;
      container.appendChild(h);
      addedTitles.add(key);
    }
  }

  const createDeleteButton = (target) => {
    const btn = document.createElement('button');
    btn.className = 'delete-btn'; btn.innerHTML = '&times;'; btn.type='button';
    btn.addEventListener('click', () => {
        const titleKey = target.dataset.titleKey;
        const parent = target.parentElement;
        
        target.remove();

        if (titleKey) {
            const remainingBlocks = document.querySelector(`[data-title-key="${titleKey}"]`);
            if (!remainingBlocks) {
                const titleElement = document.querySelector(`.exercise-title[data-title-key="${titleKey}"]`);
                if (titleElement) {
                    titleElement.remove();
                }
                addedTitles.delete(titleKey);
            }
        }
        
        if (parent.classList.contains('honderdveld-row') && parent.children.length === 0) {
            parent.remove();
        }
    }, {once:true});
    return btn;
  };
  
  const group = (p) => { const g=document.createElementNS(NS,'g'); p.appendChild(g); return g; };
  const line  = (p,x1,y1,x2,y2,str,w) => { const l=document.createElementNS(NS,'line');
    l.setAttribute('x1',x1); l.setAttribute('y1',y1); l.setAttribute('x2',x2); l.setAttribute('y2',y2);
    l.setAttribute('stroke',str||'#6b879a'); l.setAttribute('stroke-width',w||'2'); p.appendChild(l); return l;};
  const label = (p,x,y,txt) => {
    const g=group(p);
    const r=document.createElementNS(NS,'rect');
    r.setAttribute('x',x-16); r.setAttribute('y',y-24);
    r.setAttribute('width',32); r.setAttribute('height',22);
    r.setAttribute('fill','#fff'); r.setAttribute('stroke','#6b879a'); r.setAttribute('stroke-width','2'); r.setAttribute('rx',6);
    g.appendChild(r);
    const t=document.createElementNS(NS,'text');
    t.setAttribute('x',x); t.setAttribute('y',y-8); t.setAttribute('text-anchor','middle'); t.setAttribute('font-size','13'); t.setAttribute('font-weight','700');
    t.textContent=String(txt);
    g.appendChild(t);
  };

  function getRulerOpts() {
    return {
      start: parseInt($('#start').value,10), end: parseInt($('#end').value,10), unit: Math.max(1, parseInt($('#unit').value,10)),
      showZero: $('#showZero').checked, showEnds: $('#showEnds').checked, showTens: $('#showTens').checked,
      showFives: $('#showFives').checked, showOnes: $('#showOnes').checked, majorStep: parseInt($('#majorStep').value,10),
      mode: $$('input[name=mode]:checked')[0].value,
      dragValues: $('#dragList').value.split(/[ ,;]+/).map(s=>s.trim()).filter(s=>s.length>0).map(s=>parseInt(s,10)),
      blankCount: parseInt($('#blankCount').value,10)
    };
  }
  const wantLabel = (val, o) => o.showOnes || (o.showTens&&val%10===0) || (o.showFives&&val%5===0) || (o.showZero&&val===0) || (o.showEnds&&(val===o.start||val===o.end));

  function drawRuler(svgEl, o) {
    const width = svgEl.clientWidth || 1000;
    const height = 220;
    svgEl.setAttribute('viewBox', '0 0 ' + width + ' ' + height);
    svgEl.innerHTML = '';
    const baseY = Math.round(height * 0.44);
    const padL = PAD_L, padR = PAD_R;
    const units=o.end-o.start; if(units<=0) return {ticks:[],baseY:baseY,g:null,width:width,height:height};
    const pxPerUnit=(width-padL-padR)/units;
    const g=group(svgEl);
    const defs = document.createElementNS(NS,'defs');
    const marker = document.createElementNS(NS,'marker');
    marker.setAttribute('id','arrowhead'); marker.setAttribute('markerWidth','8'); marker.setAttribute('markerHeight','8');
    marker.setAttribute('refX','4'); marker.setAttribute('refY','4'); marker.setAttribute('orient','auto');
    const tip = document.createElementNS(NS,'path');
    tip.setAttribute('d','M0,0 L8,4 L0,8 Z'); tip.setAttribute('fill','#1e88e5');
    marker.appendChild(tip); defs.appendChild(marker); g.appendChild(defs);
    line(g,padL,baseY,width-padR+5,baseY);
    const ticks=[];
    for(let v=o.start; v<=o.end; v+=o.unit){
        const x=padL+(v-o.start)*pxPerUnit;
        const isMajor=(v%o.majorStep===0);
        const h=isMajor?18: (v%5===0?12:9);
        line(g,x,baseY,x,baseY-h);
        ticks.push({v:v,x:x,isMajor:isMajor});
    }
    ticks.forEach(t=>{if(wantLabel(t.v, o))label(g,t.x,baseY-(t.isMajor?24:18),t.v);});
    return {ticks:ticks, baseY:baseY, g:g, width: width, height: height};
  }

  function renderPreview(){ const o=getRulerOpts(); if(o.end<=o.start) return; drawRuler(previewSvg, o); }

  function addExerciseToSheet(){
    const o=getRulerOpts(); if(o.end<=o.start){alert('Tot en met moet groter zijn dan Van.');return;}
    let titleKey=null, titleText=null;
    if (o.mode==='drag'){ titleKey='ruler_drag'; titleText='Verbind de getallen met de getallenlijn.'; }
    if (o.mode==='blanks'){ titleKey='ruler_blanks'; titleText='Vul de ontbrekende getallen in.'; }
    if (titleKey) ensureTitleOnce(sheet, titleKey, titleText);

    const ex=document.createElement('div'); ex.className='exercise'; 
    if(titleKey) ex.dataset.titleKey = titleKey;
    ex.appendChild(createDeleteButton(ex));
    
    if(o.mode==='drag') ex.classList.add('drag'); if(o.mode==='blanks') ex.classList.add('blanks');
    const svg=document.createElementNS(NS,'svg'); ex.appendChild(svg); sheet.appendChild(ex);
    const res=drawRuler(svg, o); const {ticks, baseY, g}=res;
    if (o.mode==='drag') {
      let values = o.dragValues.filter(Number.isFinite);
      if (!values.length) { values = ticks.filter(t=>t.isMajor).map(t=>t.v).slice(0,6); }
      const cardWidth=52, gap=14, n=values.length;
      const totalWidth = n*cardWidth+(n-1)*gap;
      const svgRect = svg.getBoundingClientRect();
      const exRect  = ex.getBoundingClientRect();
      const rulerLeft  = (svgRect.left - exRect.left) + PAD_L;
      const rulerRight = (svgRect.right - exRect.left) - PAD_R;
      const rulerWidth = rulerRight - rulerLeft;
      const DRAG_X_SHIFT = 0;
      const startX = rulerLeft + (rulerWidth - totalWidth)/2 + DRAG_X_SHIFT;
      const DRAW_GAP = 70;
      const topPos = (svgRect.top - exRect.top) + baseY + DRAW_GAP;
      values.forEach((val,i)=>{
        const c=document.createElement('div'); c.className='card'; c.textContent=val;
        c.style.position='absolute';
        c.style.left = Math.round(startX + i*(cardWidth+gap)) + 'px';
        c.style.top  = Math.round(topPos) + 'px';
        ex.appendChild(c);
      });
    }
    if(o.mode==='blanks'){
      const all=ticks.filter(t=>!wantLabel(t.v,o)).sort(()=>Math.random()-0.5);
      const minGap=36, picked=[]; for(const t of all){ if(picked.length>=o.blankCount) break; if(picked.every(p=>Math.abs(p.x-t.x)>=minGap)) picked.push(t); }
      picked.sort((a,b)=>a.x-b.x);
      let above=true; const bw=46,bh=34, offA=40, offB=32, margin=10;
      const svgRect=svg.getBoundingClientRect(), pageX=window.scrollX, pageY=window.scrollY;
      picked.forEach(t=>{
        const xC=t.x, x=xC-bw/2; let y; const conn=line(g,xC,baseY,xC,0,'#1e88e5','1.6');
        if(above){ y=baseY-(offA+12)-bh; if(y<margin) y=margin; conn.setAttribute('y2',Math.min(y+bh+2,svg.height.baseVal.value-margin)); }
        else{ y=baseY+(offB+14); if(y+bh>svg.height.baseVal.value-margin) y=svg.height.baseVal.value-margin-bh; conn.setAttribute('y2',Math.max(y-2,margin)); }
        conn.setAttribute('marker-end','url(#arrowhead)');
        const rect=document.createElementNS(NS,'rect'); rect.setAttribute('x',x); rect.setAttribute('y',y);
        rect.setAttribute('width',bw); rect.setAttribute('height',bh); rect.setAttribute('rx',9); rect.setAttribute('fill','#fff'); rect.setAttribute('stroke','#c9d6ea'); rect.setAttribute('stroke-width','2'); g.appendChild(rect);
        const htmlBox=document.createElement('input'); htmlBox.type='text'; htmlBox.className='print-overlay-input';
        htmlBox.style.left=(svgRect.left+pageX+x)+'px'; htmlBox.style.top=(svgRect.top+pageY+y)+'px'; htmlBox.style.width=bw+'px'; htmlBox.style.height=bh+'px';
        htmlBox.style.border='2px solid #c9d6ea'; htmlBox.style.borderRadius='9px'; htmlBox.style.textAlign='center'; htmlBox.style.fontWeight='700'; htmlBox.style.font='inherit';
        ex.appendChild(htmlBox); above=!above;
      });
    }
  }

  function drawJumpArcsInline(row, labels){
      const ex = row.parentElement;
      const old = ex.querySelector('.jump-arc-wrapper'); 
      if (old) old.remove();
      const items = Array.from(row.children);
      if (items.length < 2) return;
      const rowRect = row.getBoundingClientRect();
      const SHIFT_ALL_PX   = -18;
      const SHIFT_START_PX = -3;
      const centers = items.map(el => (el.getBoundingClientRect().left - rowRect.left) + el.offsetWidth/2);
      const pts = centers.map((c, i) => c + SHIFT_ALL_PX + (i===0 ? SHIFT_START_PX : 0));
      const width = Math.round(rowRect.width);
      const wrap = document.createElement('div');
      wrap.className = 'jump-arc-wrapper';
      wrap.style.width = width + 'px';
      wrap.style.marginLeft = row.offsetLeft + 'px';
      ex.insertBefore(wrap, row);
      const h = 18;
      const svg = document.createElementNS(NS,'svg');
      svg.classList.add('jump-arcs-inline');
      svg.setAttribute('viewBox', `0 0 ${width} ${h+12}`);
      svg.style.width  = width + 'px';
      svg.style.height = (h+12) + 'px';
      wrap.appendChild(svg);
      const labelsLayer = document.createElement('div');
      labelsLayer.className = 'arc-labels';
      wrap.appendChild(labelsLayer);
      for (let i=0; i<pts.length-1; i++){
        const x1 = pts[i], x2 = pts[i+1];
        const path = document.createElementNS(NS,'path');
        path.setAttribute('d', `M ${x1},${h} C ${x1},6 ${x2},6 ${x2},${h}`);
        svg.appendChild(path);
        const span = document.createElement('span');
        span.className = 'arc-label';
        span.style.left = ((x1 + x2)/2) + 'px';
        span.textContent = labels[i] || '';
        labelsLayer.appendChild(span);
      }
  }

  function addJumpExercise() {
    const start=parseInt($('#jumpStart').value,10);
    const step=parseInt($('#jumpStep').value,10);
    const count=Math.max(1, parseInt($('#jumpCount').value,10));
    const discover=$('#jumpDiscover').checked;
    const key = discover ? 'jump_discover' : 'jump_fixed';
    ensureTitleOnce(sheet, key, discover?'Welke sprong wordt er gemaakt? Vul de rij verder aan.':'Tel met sprongen.');
    const block=document.createElement('div'); block.className='jump-exercise-block'; block.appendChild(createDeleteButton(block));
    block.dataset.titleKey = key;
    if (discover) {
      const p=document.createElement('div'); p.className='discover-jump-prompt';
      p.innerHTML='De sprong is + <input type="text" class="jump-box" style="width:46px;height:34px;display:inline-block;vertical-align:middle;">';
      block.appendChild(p);
    }
    const ex=document.createElement('div'); ex.className='jump-exercise';
    const row=document.createElement('div'); row.className='jump-row';
    const seq=Array.from({length:count},(_,i)=>start+i*step);
    if (discover) {
      const givenPosText=($('#jumpGivenPositions').value||'').trim();
      const includeStart=$('#jumpIncludeStart').checked;
      const includeEnd=$('#jumpIncludeEnd').checked;
      const wantCount=Math.max(0, parseInt($('#jumpGivenCount').value,10)||0);
      let indices=new Set();
      if (givenPosText.length){
        givenPosText.split(/[ ,;]+/).forEach(s=>{ const k=parseInt(s,10); if(Number.isFinite(k)&&k>=1&&k<=count) indices.add(k-1); });
      } else {
        while(indices.size<Math.min(wantCount,count)){ indices.add(Math.floor(Math.random()*count)); }
      }
      if (includeStart) indices.add(0);
      if (includeEnd)   indices.add(count-1);
      const startEl=document.createElement('div'); startEl.className='jump-start'; startEl.textContent=seq[0]; row.appendChild(startEl);
      for(let i=1;i<count;i++){
        if (indices.has(i)){ const g=document.createElement('div'); g.className='jump-given'; g.textContent=seq[i]; row.appendChild(g); }
        else { const b=document.createElement('input'); b.className='jump-box'; row.appendChild(b); }
      }
      ex.appendChild(row); block.appendChild(ex);
    } else {
      const startEl=document.createElement('div'); startEl.className='jump-start'; startEl.textContent=start; row.appendChild(startEl);
      for(let i=0;i<count-1;i++){ const box=document.createElement('input'); box.className='jump-box'; row.appendChild(box); }
      ex.appendChild(row); block.appendChild(ex);
    }
    sheet.appendChild(block);
    requestAnimationFrame(()=>drawJumpArcsInline(row, Array(count-1).fill(discover? '?': ('+'+step))));
  }

  function rnd(max){ return Math.floor(Math.random()*(max+1)); }
  function makeTE(max){
    const maxT = Math.min(9, Math.floor(max/10));
    const patterns = ['T','E','TE'];
    const p = patterns[Math.floor(Math.random()*patterns.length)];
    let t=0, e=0, text='';
    if(p==='T'){ t = Math.max(1, rnd(maxT)); text = `${t}T`; }
    else if(p==='E'){ e = Math.max(1, Math.min(9,rnd(max))); text = `${e}E`; }
    else{
      t = Math.max(1,rnd(maxT));
      const maxE = Math.min(9, Math.max(0, max - t*10));
      e = rnd(maxE);
      const order = Math.random()<0.5 ? 'TE' : 'ET';
      text = order==='TE' ? `${t}T en ${e}E` : `${e}E en ${t}T`;
    }
    return { text, value: t*10 + e };
  }
  function makeSideTEorNumber(max){
    if(Math.random()<0.5){ return { isTE:true, ...makeTE(max) }; }
    else{ const v = rnd(max); return { isTE:false, text:String(v), value:v }; }
  }

  function addMixedExercises() {
    const type=$('#mixedType').value;
    const max=parseInt($('#mixedMax').value,10)||100;
    const n=parseInt($('#mixedCount').value,10)||9;
    
    const titles={'neighbors':'Vul de buurgetallen in.','neighborTens':'Vul de buurtientallen in.','composeTE':'Vul het getal in.','compare':'Vergelijk de getallen (vul <, = of > in).','compareTE':'Vergelijk de getallen (vul <, = of > in).'};
    const key={'neighbors':'mixed_neighbors','neighborTens':'mixed_neighborTens','composeTE':'mixed_compose_te','compare':'mixed_compare_any','compareTE':'mixed_compare_any'}[type];
    ensureTitleOnce(sheet, key, titles[type]);
    
    const block=document.createElement('div'); block.className='mixed-exercise-block'; block.appendChild(createDeleteButton(block));
    block.dataset.titleKey = key;
    const grid=document.createElement('div'); grid.className='mixed-grid';
    function box(cls=''){ const i=document.createElement('input'); i.type='text'; i.className='mix-box'+(cls?(' '+cls):''); return i; }
    function makeNum(n){ const d=document.createElement('div'); d.className='mix-num'; d.textContent=n; return d; }
    function makeLabel(txt){ const s=document.createElement('span'); s.className='mix-label'; s.textContent=txt; return s; }
    for(let i=0;i<n;i++){
      const item=document.createElement('div'); item.className='mix-item';
      if(type==='neighbors'){ const x=rnd(max); item.append(box(), makeNum(x), box()); }
      else if(type==='neighborTens'){ const x=rnd(max); item.append(box(), makeNum(x), box()); }
      else if(type==='composeTE'){ const te = makeTE(max); const eq = document.createElement('span'); eq.className='mix-eq'; eq.textContent='='; item.append(makeLabel(te.text), eq, box()); }
      else if(type==='compare'){ const a=rnd(max), b=rnd(max); const mid=box('small'); item.append(makeNum(a), mid, makeNum(b)); }
      else if(type==='compareTE'){ const left=makeSideTEorNumber(max); const right=makeSideTEorNumber(max); const mid=box('small'); const leftEl=left.isTE?makeLabel(left.text):makeNum(left.value); const rightEl=right.isTE?makeLabel(right.text):makeNum(right.value); item.append(leftEl, mid, rightEl); }
      grid.appendChild(item);
    }
    block.appendChild(grid); 
    sheet.appendChild(block);
  }

  function addSequenceExercise(){
    const start=parseInt($('#seqStart').value,10);
    const end=parseInt($('#seqEnd').value,10);
    if(!Number.isFinite(start)||!Number.isFinite(end)||start===end){ alert('Start en eind moeten verschillend zijn.'); return; }
    const lockEnds=$('#seqLockEnds').checked;
    const blanksWanted=Math.max(0, parseInt($('#seqBlankCount').value,10)||0);
    const step=start<end?1:-1;
    const seq=[]; for(let v=start; (step>0? v<=end : v>=end); v+=step) seq.push(v);
    const length=seq.length;
    const maxBlanks=lockEnds?Math.max(0,length-2):length;
    const blanks=Math.min(blanksWanted, maxBlanks);
    const allIdx=[...seq.keys()];
    if(lockEnds){ allIdx.shift(); allIdx.pop(); }
    const blankSet=new Set();
    while(blankSet.size<blanks && allIdx.length){ const k=Math.floor(Math.random()*allIdx.length); blankSet.add(allIdx.splice(k,1)[0]); }
    
    const key = 'seq_fill';
    ensureTitleOnce(sheet, key, 'Vul de getallenrij verder aan.');
    const block=document.createElement('div'); block.className='sequence-exercise-block'; block.appendChild(createDeleteButton(block));
    block.dataset.titleKey = key;
    const row=document.createElement('div'); row.className='seq-row';
    seq.forEach((n,i)=>{ if(blankSet.has(i)){ const inp=document.createElement('input'); inp.type='text'; inp.className='seq-box'; row.appendChild(inp); } else { const d=document.createElement('div'); d.className='seq-num'; d.textContent=n; row.appendChild(d); } });
    block.appendChild(row); 
    sheet.appendChild(block);
  }

  function addHonderdveldExercise() {
    const type = $('#honderdveldType').value;
    const max = parseInt($('#honderdveldMax').value, 10) || 100;
    const count = parseInt($('#honderdveldCount').value, 10) || 2;
    const twoColumns = $('#honderdveldTwoColumns').checked;

    const titles = {
        'veld-naar-getal': 'Hoeveel is het? Vul in.',
        'getal-naar-veld': 'Kleur het juiste aantal vakjes.',
        'aanvullen-tiental': 'Vul aan tot het volgend tiental.'
    };
    const key = `honderdveld_${type}`;
    ensureTitleOnce(sheet, key, titles[type]);

    let rowContainer = null;
    for (let i = 0; i < count; i++) {
        const block = document.createElement('div');
        block.className = 'honderdveld-exercise-block';
        block.dataset.titleKey = key;
        block.appendChild(createDeleteButton(block));
        
        const container = document.createElement('div');
        container.className = 'honderdveld-container';

        let num;
        if (type === 'aanvullen-tiental') {
            do { num = Math.floor(Math.random() * (max - 1)) + 1; } while (num % 10 === 0);
        } else {
            num = Math.floor(Math.random() * max) + 1;
        }
        const tens = Math.floor(num / 10);

        const grid = document.createElement('div');
        grid.className = 'honderdveld-grid';
        for (let j = 1; j <= 100; j++) {
            const cell = document.createElement('div');
            cell.className = 'honderdveld-cell';
            if (type === 'veld-naar-getal' || type === 'aanvullen-tiental') {
                if (j <= tens * 10) { cell.classList.add('filled-ten'); } 
                else if (j <= num) { cell.classList.add('filled-unit'); }
            }
            grid.appendChild(cell);
        }

        const task = document.createElement('div');
        task.className = 'honderdveld-task';

        if (type === 'veld-naar-getal') {
            const table = document.createElement('table');
            table.className = 'honderdveld-te-table';
            table.innerHTML = `<tr><td style="background-color: #4caf50; color:white;">T</td><td style="background-color: #ffeb3b;">E</td></tr><tr><td><input type="text"></td><td><input type="text"></td></tr>`;
            const numBox = document.createElement('input');
            numBox.type = 'text';
            numBox.className = 'honderdveld-num-box';
            task.append(table, numBox);
            container.append(grid, task);
        } else if (type === 'getal-naar-veld') {
            const givenNum = document.createElement('div');
            givenNum.className = 'honderdveld-given-num';
            givenNum.textContent = num;
            container.append(givenNum, grid);
        } else if (type === 'aanvullen-tiental') {
            task.className = 'aanvul-vragen';
            task.innerHTML = `<div class="aanvul-rij">Dit is <input type="text" class="aanvul-input"> T en <input type="text" class="aanvul-input"> E = <input type="text" class="aanvul-input"></div><div class="aanvul-rij">Ik vul aan tot <input type="text" class="aanvul-input"> T = <input type="text" class="aanvul-input"></div><div class="aanvul-rij">Dat zijn <input type="text" class="aanvul-input"> E erbij.</div>`;
            container.append(grid, task);
        }
        
        block.appendChild(container);

        if (twoColumns) {
            if (i % 2 === 0) {
                rowContainer = document.createElement('div');
                rowContainer.className = 'honderdveld-row';
                sheet.appendChild(rowContainer);
            }
            rowContainer.appendChild(block);
        } else {
            sheet.appendChild(block);
        }
    }
  }
  
  function createTenRodSVG(isWhite) {
      const svg = document.createElementNS(NS, 'svg');
      svg.setAttribute('viewBox', '0 0 20 100');
      const rect = document.createElementNS(NS, 'rect');
      rect.setAttribute('width', '20');
      rect.setAttribute('height', '100');
      rect.setAttribute('fill', isWhite ? '#fff' : '#4caf50');
      rect.setAttribute('stroke', isWhite ? '#888' : '#2e7d32');
      rect.setAttribute('stroke-width', '1');
      svg.appendChild(rect);
      for (let i = 1; i < 10; i++) {
          const line = document.createElementNS(NS, 'line');
          line.setAttribute('x1', '0');
          line.setAttribute('y1', i * 10);
          line.setAttribute('x2', '20');
          line.setAttribute('y2', i * 10);
          line.setAttribute('stroke', isWhite ? '#ccc' : '#2e7d32');
          line.setAttribute('stroke-width', '0.5');
          svg.appendChild(line);
      }
      return svg;
  }

  function createUnitCubeSVG(isWhite) {
      const svg = document.createElementNS(NS, 'svg');
      svg.setAttribute('viewBox', '0 0 20 20');
      svg.classList.add('unit');
      const rect = document.createElementNS(NS, 'rect');
      rect.setAttribute('width', '20');
      rect.setAttribute('height', '20');
      rect.setAttribute('fill', isWhite ? '#fff' : '#ffeb3b');
      rect.setAttribute('stroke', isWhite ? '#888' : '#fbc404');
      rect.setAttribute('stroke-width', '1');
      svg.appendChild(rect);
      return svg;
  }
  
  function createMabRepresentation(tens, units, isWhite) {
      const container = document.createElement('div');
      container.className = 'mab-labeled-container';

      const tensCol = document.createElement('div');
      tensCol.className = 'mab-column mab-column-tens';
      tensCol.innerHTML = `<div class="mab-header">T</div>`;
      const tensWrapper = document.createElement('div');
      tensWrapper.className = 'mab-blocks-wrapper mab-tens-wrapper';
      for (let t = 0; t < tens; t++) {
          tensWrapper.appendChild(createTenRodSVG(isWhite));
      }
      tensCol.appendChild(tensWrapper);

      const unitsCol = document.createElement('div');
      unitsCol.className = 'mab-column';
      unitsCol.innerHTML = `<div class="mab-header">E</div>`;
      const unitsWrapper = document.createElement('div');
      unitsWrapper.className = 'mab-blocks-wrapper mab-units-wrapper';
      for (let u = 0; u < units; u++) {
          unitsWrapper.appendChild(createUnitCubeSVG(isWhite));
      }
      unitsCol.appendChild(unitsWrapper);

      container.append(tensCol, unitsCol);
      return container;
  }

  function addMabExercise() {
    const type = $('#mabType').value;
    const max = parseInt($('#mabMax').value, 10) || 99;
    const count = parseInt($('#mabCount').value, 10) || 4;
    const key = `mab_${type}`;

    const titles = {
        'tellen': 'Hoeveel tel je? Vul in.',
        'verbinden': 'Wat is evenveel? Verbind.',
        'kleuren': 'Kleur de hoeveelheid.'
    };
    ensureTitleOnce(sheet, key, titles[type]);

    const block = document.createElement('div');
    block.className = 'mab-exercise-block';
    block.dataset.titleKey = key;
    block.appendChild(createDeleteButton(block));
    
    if (type === 'tellen' || type === 'kleuren') {
        const grid = document.createElement('div');
        grid.className = 'mab-grid-layout';
        
        for (let i = 0; i < count; i++) {
            const num = Math.floor(Math.random() * max) + 1;
            const isWhite = (type === 'kleuren');
            
            const container = document.createElement('div');
            
            const mabVisual = createMabRepresentation(isWhite ? 9 : Math.floor(num/10), isWhite ? 9 : num % 10, isWhite);
            
            if(isWhite) {
                container.className = 'mab-color-layout';
                const numDiv = document.createElement('div');
                numDiv.className = 'mab-color-num';
                numDiv.textContent = num;
                container.append(numDiv, mabVisual);
            } else {
                container.className = 'mab-tellen-container';
                const table = document.createElement('table');
                table.className = 'mab-te-table';
                table.innerHTML = `<tr><td class="te-label">T</td><td class="te-label e">E</td></tr><tr><td><input type="text"></td><td><input type="text"></td></tr>`;
                container.append(mabVisual, table);
            }
            grid.appendChild(container);
        }
        block.appendChild(grid);
    } else if (type === 'verbinden') {
        const layout = document.createElement('div');
        layout.className = 'mab-connect-layout';
        const colBlocks = document.createElement('div');
        colBlocks.className = 'mab-connect-col';
        const colNums = document.createElement('div');
        colNums.className = 'mab-connect-col';
        
        let numbers = new Set();
        while (numbers.size < count) {
            numbers.add(Math.floor(Math.random() * max) + 1);
        }
        const numbersArr = Array.from(numbers);
        const shuffledNumbers = [...numbersArr].sort(() => Math.random() - 0.5);

        for (let i = 0; i < count; i++) {
            const num = numbersArr[i];
            const mabVisual = createMabRepresentation(Math.floor(num/10), num % 10, false);
            const itemBox = document.createElement('div');
            itemBox.className = 'mab-connect-item';
            itemBox.appendChild(mabVisual);
            
            const blockRow = document.createElement('div');
            blockRow.className = 'mab-connect-row';
            const dotLeft = document.createElement('div');
            dotLeft.className = 'connect-dot';
            blockRow.appendChild(itemBox);
            blockRow.appendChild(dotLeft);
            colBlocks.appendChild(blockRow);

            const numBox = document.createElement('div');
            numBox.className = 'mab-connect-num';
            numBox.textContent = shuffledNumbers[i];
            
            const numRow = document.createElement('div');
            numRow.className = 'mab-connect-row';
            const dotRight = document.createElement('div');
            dotRight.className = 'connect-dot';
            numRow.appendChild(dotRight);
            numRow.appendChild(numBox);
            colNums.appendChild(numRow);
        }
        layout.append(colBlocks, colNums);
        block.appendChild(layout);
    }
    sheet.appendChild(block);
  }

  /* Header + suggesties */
  function renderSheetHeader(){ if (sheet.querySelector('.sheetHeader')) return;
    const h=document.createElement('div'); h.className='sheetHeader';
    h.innerHTML=`
        <div style="margin-bottom: 16px;">
            <strong>Naam:</strong> <span style="display:inline-block;border-bottom:1px solid #333;min-width:200px;">&nbsp;</span>
        </div>
        <h2 style="text-align: center; margin: 0 0 10px 0; font-size: 22px; font-weight: 600;">Extra oefenen op getalinzicht</h2>
    `;
    sheet.insertBefore(h, sheet.firstChild);
  }
  function updateDragSuggestions() {
    const start=parseInt($('#start').value,10), end=parseInt($('#end').value,10); if(end<=start) return;
    const set=new Set(); while(set.size<3){ set.add(Math.floor(Math.random()*(end-start+1))+start); }
    $('#dragList').value=Array.from(set).sort((a,b)=>a-b).join(', ');
  }

  /* PDF slicing */
  function buildPageSlices(canvas, sheetRect, domBlocks, pxPerMm, pageW, pageH){
    const factor = canvas.width / sheetRect.width;
    const pageHeightPx = pageH * pxPerMm;
    const safety = 10 * pxPerMm;
    const blocks = domBlocks.map(el => {
      const r = el.getBoundingClientRect();
      const top  = (r.top  - sheetRect.top) * factor;
      const bottom = (r.bottom - sheetRect.top) * factor;
      return { top, bottom, height: bottom-top };
    }).sort((a,b)=>a.top-b.top);
    const slices = [];
    let startY = 0;
    let cursor = 0;
    for (let i=0;i<blocks.length;i++){
      const b = blocks[i];
      if ((b.bottom - startY) > (pageHeightPx - safety)) {
        if (cursor > startY) { slices.push({ y: startY, h: cursor - startY }); startY = cursor; }
        else { slices.push({ y: startY, h: pageHeightPx }); startY = startY + pageHeightPx; }
      }
      cursor = b.bottom;
    }
    const totalHeight = canvas.height;
    if (totalHeight - startY > 1) { slices.push({ y: startY, h: totalHeight - startY }); }
    return slices;
  }

  /* Events */
  $$('#controls fieldset:first-of-type input, #controls fieldset:first-of-type select').forEach(el=>el.addEventListener('input',renderPreview));
  $$('input[name=preset], input#start, input#end').forEach(el=>el.addEventListener('change',updateDragSuggestions));
  $$('input[name=preset]').forEach(r=>r.addEventListener('change',e=>{ const ab=e.target.value.split('-').map(Number); $('#start').value=ab[0]; $('#end').value=ab[1]; renderPreview(); updateDragSuggestions(); }));
  $$('input[name=mode]').forEach(r=>r.addEventListener('change',()=>{ const v=$$('input[name=mode]:checked')[0].value; $('#mode-drag').style.display=(v==='drag')?'block':'none'; $('#mode-blanks').style.display=(v==='blanks')?'block':'none'; }));
  $('#jumpDiscover').addEventListener('change',e=>{ $('#jumpDiscoverOptions').style.display = e.target.checked ? 'block' : 'none'; });

  $('#btnAddToSheet').addEventListener('click', addExerciseToSheet);
  $('#btnAddJumpExercise').addEventListener('click', addJumpExercise);
  $('#btnAddMixed').addEventListener('click', addMixedExercises);
  $('#btnAddSequence').addEventListener('click', addSequenceExercise);
  $('#btnAddHonderdveld').addEventListener('click', addHonderdveldExercise);
  $('#btnAddMab').addEventListener('click', addMabExercise);

  $('#btnClearSheet').addEventListener('click',()=>{ sheet.innerHTML=''; addedTitles.clear(); renderSheetHeader(); });
  $('#btnDownloadPdf').addEventListener('click',()=>{
    const { jsPDF } = window.jspdf;
    const el=$('#sheet');
    const del=$$('.delete-btn');
    const overlay=$$('.print-overlay-input');
    del.forEach(b=>b.style.display='none');
    overlay.forEach(i=>i.style.visibility='hidden');
    const blocks=Array.from(el.querySelectorAll('.exercise, .jump-exercise-block, .mixed-exercise-block, .sequence-exercise-block, .honderdveld-row, .honderdveld-exercise-block:not(.honderdveld-row .honderdveld-exercise-block), .mab-exercise-block'));
    const rect=el.getBoundingClientRect();
    html2canvas(el,{scale:2,backgroundColor:'#ffffff'}).then(canvas=>{
      del.forEach(b=>b.style.display='block');
      overlay.forEach(i=>i.style.visibility='visible');
      const pdf=new jsPDF({orientation:'p',unit:'mm',format:'a4'});
      const pageW=pdf.internal.pageSize.getWidth(), pageH=pdf.internal.pageSize.getHeight();
      const pxPerMm=canvas.width/pageW;
      const slices=buildPageSlices(canvas,rect,blocks,pxPerMm,pageW,pageH);
      const leftMargin=15, rightMargin=10, topMargin=8;
      const usableW = pageW - leftMargin - rightMargin;
      slices.forEach((sl,i)=>{
        const c=document.createElement('canvas'); c.width=canvas.width; c.height=sl.h;
        c.getContext('2d').drawImage(canvas,0,sl.y,canvas.width,sl.h,0,0,canvas.width,sl.h);
        const img=c.toDataURL('image/jpeg',0.9);
        if(i>0) pdf.addPage();
        const imgH=(sl.h*usableW)/canvas.width;
        pdf.addImage(img,'JPEG',leftMargin,topMargin,usableW,imgH);
      });
      pdf.save('werkblad.pdf');
    });
  });

  renderSheetHeader(); renderPreview(); updateDragSuggestions(); $$('input[name=mode]')[0].dispatchEvent(new Event('change'));
})();
</script>
</body>
</html>